<html>

<head>
  <script src="JavaScript\NeuralNetwork.js"></script>
  <meta name="viewport" content="width=400" />
  <title>Neural Network Display</title>
  <script type="text/javascript">

    var gIntervalHandle;
    var gIsTrainning = false;
    var gTrainIndex = 0;

    var gNeuralNet;
    var gNNLayerCount = 2;
    var gNNInputCount = 4;
    var gNNOutputCount = 4;

    var gNodeRadius = 10;
    var gNodeDistance = 50;
    var gLayerDistance = 75;
    var gInputArray = Array(0, 0, 0, 0);
    var gTrainingSet;

    function init() {
      var wCanvas = document.getElementById("OuputCanvas");
      wCanvas.addEventListener("mousedown", MazeClick, false);

      resize();

      gNeuralNet = new NeuralNet(gNNLayerCount, gNNInputCount, gNNOutputCount);

      gIntervalHandle = setInterval(processTick, 100);

      gTrainingSet = [];
      var wArray = [];
      for (var i = 0; i < gNNInputCount; ++i) {
        wArray.push(0);
      }
      gTrainingSet.push(copyArray(wArray));

      var wIsAllOnes = false;
      while (false == wIsAllOnes) {
        for (var i = 0; i < gNNInputCount; ++i) {
          if (0 == wArray[i]) {
            wArray[i] = 1;
            break;
          }
          else {
            wArray[i] = 0;
          }
        }

        gTrainingSet.push(copyArray(wArray));
        wIsAllOnes = true;
        for (var i = 0; i < gNNInputCount; ++i) {
          if (0 == wArray[i]) {
            wIsAllOnes = false;
            break;
          }
        }
      }
    }

    function updateSetInterval() {

      var wRange = document.getElementById("timeStep");
      clearInterval(gIntervalHandle);

      gIntervalHandle = setInterval(processTick, wRange.value);
    }

    function updateSetInterval() {

      var wRange = document.getElementById("timeStep");
      clearInterval(gIntervalHandle);

      gIntervalHandle = setInterval(processTick, wRange.value);
    }

    function setTrainFunction() {
      gIsTrainning = true;
    }

    function setTestFunction() {
      gIsTrainning = false;
    }

    function MazeClick(iEvent) {

      var wCanvas = document.getElementById("OuputCanvas");

      var wSize = wCanvas.parentElement.clientHeight;
      if (wSize > wCanvas.parentElement.clientWidth) wSize = wCanvas.parentElement.clientWidth;

      var wCellSizeX = wSize / gMazeWidth;
      var wCellSizeY = wSize / gMazeHeight;

      x = Math.floor((iEvent.x - wCanvas.offsetLeft) / wCellSizeX);
      y = Math.floor((iEvent.y - wCanvas.offsetTop) / wCellSizeY);

      var wIndex = getMazeIndex(x, y);

      if (wIndex < gMaze.length) {
        gMaze[wIndex] += 1;
        gMaze[wIndex] %= 4;
      }
    }

    function processTick() {

      var wCanvas = document.getElementById("OuputCanvas");

      if (true == gIsTrainning) {
        for (var i = 0; i < 50; ++i) {
          gNeuralNet.trainNeuralNet(gTrainingSet[gTrainIndex % gTrainingSet.length], gTrainingSet[(gTrainIndex + 1) % gTrainingSet.length]);
          //       gNeuralNet.trainNeuralNet(gTrainingSet[1], gTrainingSet[2]);
        }
        ++gTrainIndex;
      }
      else {

        for (var i = 0; i < gInputArray.length; ++i) {
          gInputArray[i] = invSigmoid(gInputArray[i]);
        }
        gInputArray = gNeuralNet.computeOutput(gInputArray);
      }

      drawNeuralNet(wCanvas, gNeuralNet);


      var wTextArea = document.getElementById("TextArea");
      wTextArea.innerHTML = JSON.stringify(gNeuralNet.mLayerValues);
    }

    function drawNeuralNet(iDOM, iNeuralNet) {
      var wCtx = iDOM.getContext("2d");
      var wCanvasHeight = iDOM.height;
      var wCanvasWidth = iDOM.width;

      wCtx.clearRect(0, 0, wCanvasWidth, wCanvasHeight);
      var wCanvasHeightCenter = iDOM.height / 2;
      var wCanvasWidthCenter = iDOM.width / 2;

      wCtx.translate(wCanvasWidthCenter, wCanvasHeightCenter);
      wCtx.fillStyle = "cyan";
      wCtx.strokeStyle = "cyan";
      wCtx.lineWidth = 3;

      iNeuralNet.draw(wCtx, gNodeRadius, gLayerDistance, gNodeDistance, "red", "red");

      wCtx.translate(-wCanvasWidthCenter, -wCanvasHeightCenter);
    }

  </script>
  <script type="module">

    import { NeuralNetwork, DrawNeuralNetwork, PrintNeuralNetworkToString } from "../../modules/NeuralNetwork.mjs"

    var gIOSize = 3;
    var gGlobal = {
        NeuralNetwork: new NeuralNetwork([gIOSize, 5, 9, 8, gIOSize])
      , LearningRate: 0.05
      , NodeRadius: 10
      , NodeDistance: 50
      , LayerDistance: 75
      , OperationMode: "test"
      , InitialInputVector: [0,0,0]
      , LastInputVector: null
      , LastOutputVector: null
      , LastExpectedOutput: null
      , Id_OuputCanvasDiv: "id_OuputCanvas"
      , Id_OuputTextArea: "id_TextArea"
      , Id_InputButtonTrain: "id_button_train"
      , Id_InputButtonTest: "id_button_test"
      , Id_InputButtonNext: "id_button_next"
      , TrainingSequence: []
      , TrainingSequenceIndex : 0
    };

    function processNeralNet(iInput) {
      gGlobal.LastInputVector = iInput;
      gGlobal.LastOutputVector = gGlobal.NeuralNetwork.processInput(gGlobal.LastInputVector);
    }

    function trainNeralNet(iInput, iOutput) {
      gGlobal.LastInputVector = iInput;
      gGlobal.LastExpectedOutput = iOutput;
      gGlobal.LastOutputVector = gGlobal.NeuralNetwork.trainPair(iInput, iOutput, gGlobal.LearningRate);
    }

    function drawNeuralNet(iDOM, iNeuralNet) {
      var wCtx = iDOM.getContext("2d");
      var wCanvasHeight = iDOM.height;
      var wCanvasWidth = iDOM.width;

      wCtx.clearRect(0, 0, wCanvasWidth, wCanvasHeight);
      var wCanvasHeightCenter = wCanvasHeight / 2;
      var wCanvasWidthCenter = wCanvasWidth / 2;

      wCtx.translate(wCanvasWidthCenter, wCanvasHeightCenter);
      wCtx.lineWidth = 3;

      DrawNeuralNetwork(wCtx, iNeuralNet, gGlobal.NodeRadius, gGlobal.NodeDistance, gGlobal.LayerDistance, "cyan", "red");

      wCtx.translate(-wCanvasWidthCenter, -wCanvasHeightCenter);
    }

    function loop() {
      window.requestAnimationFrame(loop);

      if("test" == gGlobal.OperationMode) {
      //  wLastInput = gGlobal.NeuralNetwork.processInput(wLastInput);
      }
      else if("train" == gGlobal.OperationMode) {
        gGlobal.TrainingSequenceIndex += 1;
        gGlobal.TrainingSequenceIndex %= gGlobal.TrainingSequence.length;
        
        var wIndex1 = gGlobal.TrainingSequenceIndex ;
        var wIndex2 = (1 + gGlobal.TrainingSequenceIndex)%gGlobal.TrainingSequence.length;
        trainNeralNet(gGlobal.TrainingSequence[wIndex1], gGlobal.TrainingSequence[wIndex2]);
      }
      
      var wCanvas = document.getElementById(gGlobal.Id_OuputCanvasDiv);
      drawNeuralNet(wCanvas, gGlobal.NeuralNetwork);
      
      if(null != gGlobal.LastInputVector){      
        var wString = "Operation Mode : " + gGlobal.OperationMode + "\n\n";

        wString += "Input Vector : " + JSON.stringify(gGlobal.LastInputVector);
        wString += "\n\n";
        
        wString += "Expected Output Vector : " + JSON.stringify(gGlobal.LastExpectedOutput);
        wString += "\n\n";
    
        wString += "Output Vector : " + JSON.stringify(gGlobal.LastOutputVector);
        wString += "\n\n";
        wString += PrintNeuralNetworkToString(gGlobal.NeuralNetwork);
        document.getElementById(gGlobal.Id_OuputTextArea).value = wString;
      }
      
    }

    function init() {

      document.getElementById(gGlobal.Id_InputButtonTrain).addEventListener(
        "click",
        function(){
          gGlobal.OperationMode = "train";
        }
      )

      document.getElementById(gGlobal.Id_InputButtonTest).addEventListener(
        "click",
        function () {
          gGlobal.OperationMode = "test";
        }
      )

      document.getElementById(gGlobal.Id_InputButtonNext).addEventListener(
        "click",
        function () {

          if ("test" == gGlobal.OperationMode) {
            
              gGlobal.TrainingSequenceIndex %= gGlobal.TrainingSequence.length;
              processNeralNet(gGlobal.TrainingSequence[gGlobal.TrainingSequenceIndex]);
              gGlobal.TrainingSequenceIndex +=1;
              
              gGlobal.LastExpectedOutput = gGlobal.TrainingSequence[gGlobal.TrainingSequenceIndex%gGlobal.TrainingSequence.length];
          }
        }
      )
      
      var wSetSize = Math.pow(2,gIOSize);
      var wNumber = 0;
      gGlobal.TrainingSequence = [];
      for(var wi = 0; wi < wSetSize; ++wi) {
        var wSet = [];
        var wRemainder = wNumber;
        for(var wj = gIOSize-1; wj >= 0; --wj) {
          var wMultiplier = Math.pow(2, wj);
          var wCount = Math.floor(wRemainder/wMultiplier);
          wRemainder -= wCount*wMultiplier;
          wSet.push(wCount);
        }
        gGlobal.TrainingSequence.push(wSet);
        wNumber += 1;
      }



      resize();
      loop();
    }

    function resize() {
      var wCanvas = document.getElementById(gGlobal.Id_OuputCanvasDiv);
      wCanvas.height = wCanvas.parentElement.clientHeight - 2;
      wCanvas.width = wCanvas.parentElement.clientWidth - 2;
    }


    window.addEventListener("load", init);
    window.addEventListener("resize", resize);

  </script>
  <style>
    body {
      background-color: rgb(0, 0, 0);
    }

    div {
      height: 100%;
      width: 100%;
    }

    table {
      height: 100%;
      width: 100%;
    }
    td {
      width: 50%;
    }

    textArea {
      background-color: rgb(255, 255, 255);
      height: 90%;
      width: 100%;
    }

    canvas {
      border: 1px solid blue;
    }
  </style>
</head>

<body>
  <div>
    <table>
      <tr>
        <td>
          <canvas id="id_OuputCanvas"></canvas>
        </td>
        <td>
          <input type="button" id="id_button_train" value="Train" />
          <input type="button" id="id_button_test" value="Test" />
          <input type="button" id="id_button_next" value="Next" />
          <input type="range" id="timeStep" value="50" max="1000" min="50" onchange="updateSetInterval()" />
          <textarea id="id_TextArea"></textarea>
        </td>
      </tr>
    </table>
  </div>
</body>

</html>