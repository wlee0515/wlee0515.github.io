<HTML>
<HEAD>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <TITLE>Media Capture Demonstration</TITLE>
  <script type="text/javascript" src="../../global/frame.js"></script>  
  <!--
  <link rel="stylesheet" href="../../css/theme_01.css" />
  -->

  <script>

    var gGlobal = {
      InputCameraSrc : [],
      InputCameraIdPrefix : "id_InputCamera_",
      InputCameraCount : 0,
      InputAudioIdPrefix : "id_InputAudio_",
      OutputVideoId : "id_video_div",
      OutputTextId : "id_TextOut_div"
    }

    function  stopStreams() {
        if (window.stream) {
          window.stream.getTracks().forEach(track => {
          track.stop();
        });
      }
    }

    function getDeviceList() {
      return navigator.mediaDevices.enumerateDevices();
    }

    function loadDevices(iDeviceList) {
      
      var wTextOut = document.getElementById(gGlobal.OutputTextId);
      if (null != wTextOut) {
        wTextOut.innerText += JSON.stringify(iDeviceList, null, 2);
      }

      //get Device List
      var wDeviceList = iDeviceList;
      var wDeviceInfoList_audio = [];
      var wDeviceInfoList_video = [];
      
      // Loop through device list
      for (const wDeviceInfo of wDeviceList) {
        var wDevice = {
          Kind : wDeviceInfo.kind,
          Label : wDeviceInfo.label,
          Id : wDeviceInfo.deviceId
        }

        if (wDeviceInfo.kind === 'audioinput') {
          if ("" == wDevice.Label) {
            wDevice.Label = 'Audio ' + (wDeviceInfoList_audio.length + 1);
          }
          wDeviceInfoList_audio.push(wDevice);
        }
        else if (wDeviceInfo.kind === 'videoinput') {
          if ("" == wDevice.Label) {
            wDevice.Label = 'Camera ' + (wDeviceInfoList_audio.length + 1);
          }

          wDeviceInfoList_video.push(wDevice);
        }
      }

      for (var wi = 0; wi < wDeviceInfoList_video.length; ++wi) {

        const constraints = {
//          audio: { exact: wDeviceInfoList_audio[wi] },
          video: { exact: wDeviceInfoList_video[wi].deviceId }
        };

        navigator.mediaDevices.getUserMedia(constraints).then(processStream).catch(handleError);
      }

      alert(JSON.stringify(wDeviceInfoList_audio))
      alert(JSON.stringify(wDeviceInfoList_video))
    }

    function processStream(iStream) {

      var wVideoDom = document.getElementById(gGlobal.OutputVideoId);
      if (null != wVideoDom) {
        var wNewVideo = document.createElement('video');
        wNewVideo.srcObject = iStream;
        wNewVideo.autoplay = true;
        wNewVideo.setAttribute("muted",null);
        wNewVideo.setAttribute("playsinline",null);
        wVideoDom.append(wNewVideo);
      }
    }

    function handleError(params) {
      
    }
    function renderCanvas() {

      window.requestAnimationFrame(renderCanvas);    
    }

    function Init() {
      stopStreams();
      getDeviceList().then(loadDevices);

      Resize();
      renderCanvas();
    }

    function Resize() {
      /*
      var wCanvas = document.getElementById(gGlobal.OutputCanvasId);
      var wSize = wCanvas.parentElement.clientWidth;

      wCanvas.height = wSize - 2;
      wCanvas.width = wSize - 2;
      
      updateCurveData();
      */
    }

  </script>
  <style>

    #CurveDisplay
    {
        width : 90%;
        margin-top: 30px;
        margin-bottom: 30px;
        padding-left: 20;
    }

    canvas
    {
        border: 1px solid blue;
        background-color: white;
    }

  </style>
  
</HEAD>
<BODY onload="Init()" onresize ="Resize()">
  <div id="main-content-div">
    <div id="id_video_div">
    </div>
    <div id="id_TextOut_div">
    </div>


  <!--
  <div class="select">
    <label for="audioSource">Audio source: </label><select id="audioSource"></select>
  </div>

  <div class="select">
    <label for="videoSource">Video source: </label><select id="videoSource"></select>
  </div>

  <video autoplay muted playsinline></video>
  

  <script>
  
var videoElement = document.querySelector('video');
var audioSelect = document.querySelector('select#audioSource');
var videoSelect = document.querySelector('select#videoSource');

audioSelect.onchange = getStream;
videoSelect.onchange = getStream;

getStream().then(getDevices).then(gotDevices);

function getDevices() {
  // AFAICT in Safari this only gets default devices until gUM is called :/
  return navigator.mediaDevices.enumerateDevices();
}

function gotDevices(deviceInfos) {
  window.deviceInfos = deviceInfos; // make available to console
  console.log('Available input and output devices:', deviceInfos);
  for (const deviceInfo of deviceInfos) {
    const option = document.createElement('option');
    option.value = deviceInfo.deviceId;
    if (deviceInfo.kind === 'audioinput') {
      option.text = deviceInfo.label || `Microphone ${audioSelect.length + 1}`;
      audioSelect.appendChild(option);
    } else if (deviceInfo.kind === 'videoinput') {
      option.text = deviceInfo.label || `Camera ${videoSelect.length + 1}`;
      videoSelect.appendChild(option);
    }
  }
}

function getStream() {
  if (window.stream) {
    window.stream.getTracks().forEach(track => {
      track.stop();
    });
  }
  const audioSource = audioSelect.value;
  const videoSource = videoSelect.value;
  const constraints = {
    audio: {deviceId: audioSource ? {exact: audioSource} : undefined},
    video: {deviceId: videoSource ? {exact: videoSource} : undefined}
  };
  return navigator.mediaDevices.getUserMedia(constraints).
    then(gotStream).catch(handleError);
}

function gotStream(stream) {
  window.stream = stream; // make stream available to console
  audioSelect.selectedIndex = [...audioSelect.options].
    findIndex(option => option.text === stream.getAudioTracks()[0].label);
  videoSelect.selectedIndex = [...videoSelect.options].
    findIndex(option => option.text === stream.getVideoTracks()[0].label);
  videoElement.srcObject = stream;
}

function handleError(error) {
  console.error('Error: ', error);
}

  </script>
  <video id="video" width="640" height="480" autoplay></video>
  <button id="snap">Snap Photo</button>
  <canvas id="canvas" width="640" height="480"></canvas>
  <script>
  // Grab elements, create settings, etc.
var video = document.getElementById('video');

// Get access to the camera!
if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    // Not adding `{ audio: true }` since we only want video now
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
        //video.src = window.URL.createObjectURL(stream);
        video.srcObject = stream;
        video.play();
    });
}
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');
var video = document.getElementById('video');

// Trigger photo take
document.getElementById("snap").addEventListener("click", function() {
	context.drawImage(video, 0, 0, 640, 480);
});


  </script>
-->
  </div>
</BODY>
</HTML>
