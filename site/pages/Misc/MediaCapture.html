<HTML>
<HEAD>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <TITLE>Media Capture Demonstration</TITLE>
  <script type="text/javascript" src="../../global/frame.js"></script>  
  <!--
  <link rel="stylesheet" href="../../css/theme_01.css" />
  -->

  <script>

    var gGlobal = {
      OutputVideoDivId : "id_video_div",
      OutputTextId : "id_TextOut_div",
      InputCameraSelectId : "id_camera_selection",
      OutputCameraVideoId : "id_OutputCameraVideo",
      CurrentCameraStream : null,
      OutputCanvasId : "id_OutputCanvas",
      InternalVideoDOM : null
      }

    function getStream(iConstraints) {
      return navigator.mediaDevices.getUserMedia(iConstraints);
    }

    function getDeviceList() {
      // Only works after "navigator.mediaDevices.getUserMedia(iConstraints)" is called
      return navigator.mediaDevices.enumerateDevices();
    }

    function getDeviceStreamByDeviceId(iDeviceId) {

      const constraints = {
        audio: false,
        video: { deviceId : {exact: iDeviceId} }
      };

      return getStream(constraints);
    }
    
    function getDeviceStreamByFacingMode(iDirection) {

      const constraints = {
        audio: false,
        video: { facingMode: iDirection }
      };

      return getStream(constraints);
    }

    function createLiveVideoDOM() {
      var wNewVideo = document.createElement('video');
      wNewVideo.autoplay = true;
      wNewVideo.setAttribute("muted",null);
      wNewVideo.setAttribute("playsinline",null);    
      wNewVideo.play();  
      return wNewVideo;
    }

    function setVideoDOMStream(iVideoDOM, iNewStream) {
      if (null != iVideoDOM) {
        if (null != iVideoDOM.srcObject) {
          iVideoDOM.srcObject.getTracks().forEach(track => {track.stop();});
        }
        iVideoDOM.srcObject = iNewStream;
      }
    }

    function loadDevices(iDeviceList) {
      
      var wTextOut = document.getElementById(gGlobal.OutputTextId);
      if (null != wTextOut) {
        wTextOut.innerText += JSON.stringify(iDeviceList, null, 2);
      }

      //get Device List
      var wDeviceList = iDeviceList;
      var wDeviceInfoList_audio = [];
      var wDeviceInfoList_video = [];
      
      // Loop through device list
      for (const wDeviceInfo of wDeviceList) {
        var wDevice = {
          Kind : wDeviceInfo.kind,
          Label : wDeviceInfo.label,
          Id : wDeviceInfo.deviceId
        }

        if (wDeviceInfo.kind === 'audioinput') {
          if ("" == wDevice.Label) {
            wDevice.Label = 'Audio ' + (wDeviceInfoList_audio.length + 1);
          }
          wDeviceInfoList_audio.push(wDevice);
        }
        else if (wDeviceInfo.kind === 'videoinput') {
          if ("" == wDevice.Label) {
            wDevice.Label = 'Camera ' + (wDeviceInfoList_audio.length + 1);
          }

          wDeviceInfoList_video.push(wDevice);
        }
      }

      for (var wi = 0; wi < wDeviceInfoList_video.length; ++wi) {
        getDeviceStreamByDeviceId(wDeviceInfoList_video[wi].Id).then(processStream).catch(handleError);
      }
    }

    function processStream(iNewStream) {

      var wVideoDivDom = document.getElementById(gGlobal.OutputVideoDivId);
      if (null != wVideoDivDom) {
        var wNewVideo = createLiveVideoDOM();
        wVideoDivDom.append(wNewVideo);
        setVideoDOMStream(wNewVideo, iNewStream);
      }
    }

    function handleError(iError) {
      alert(iError);
    }

    function changeCurrentStream(iNewStream) {

      var wCameraDOM = document.getElementById(gGlobal.OutputCameraVideoId);
      if(null == wCameraDOM) {
        var wVideoDivDom = document.getElementById(gGlobal.OutputVideoDivId);
        if (null != wVideoDivDom) {
          var wNewVideo = createLiveVideoDOM();
          wNewVideo.id = gGlobal.OutputCameraVideoId;
          wVideoDivDom.append(wNewVideo);
          wCameraDOM = wNewVideo;
        }
      }

      if (null != wCameraDOM) {
        setVideoDOMStream(wCameraDOM, iNewStream);
      }

    }

    
    function changeCurrentStream_Internal(iNewStream) {

      var wCameraDOM = gGlobal.InternalVideoDOM;
      if (null == wCameraDOM) {
        var wNewVideo = createLiveVideoDOM();
        gGlobal.InternalVideoDOM = wNewVideo;
        wCameraDOM = wNewVideo;
      }

      if (null != wCameraDOM) {
        setVideoDOMStream(wCameraDOM, iNewStream);
      }

    }

    function updateStream() {

      var wCameraSelector = document.getElementById(gGlobal.InputCameraSelectId);
      if (null != wCameraSelector) {
        var wCameraFacing = wCameraSelector.options[wCameraSelector.selectedIndex].value;
        getDeviceStreamByFacingMode(wCameraFacing).then(changeCurrentStream).catch(handleError);
      }
    }
    
    function renderCanvas() {

      //var wCameraDOM =  gGlobal.InternalVideoDOM;
      var wCameraDOM = document.getElementById(gGlobal.OutputCameraVideoId);
      var wCanvasDOM = document.getElementById(gGlobal.OutputCanvasId);
      if((null != wCameraDOM) && (null != wCanvasDOM)) {
        var wHeight = wCameraDOM.videoHeight;
        var wWidth = wCameraDOM.videoWidth;
        
        wCanvasDOM.height = wHeight;
        wCanvasDOM.width = wWidth;
        
        var wCtx = wCanvasDOM.getContext('2d');
	      wCtx.drawImage(wCameraDOM, 0, 0, wWidth, wHeight);
      
        var wImageData = wCtx.getImageData(0, 0, wWidth, wHeight);
        var wData = wImageData.data;
        
        for (var wi = 0; wi < wWidth; ++wi) {
          for (var wj = 0; wj < wHeight; ++wj) {
            if (wi > wWidth/2) {

              var wIndex = wi* wHeight + wj;
              wData[wIndex]     = 255 - wData[wIndex];     // red
              wData[wIndex + 1] = 255 - wData[wIndex + 1]; // green
              wData[wIndex + 2] = 255 - wData[wIndex + 2]; // blue
            }
          }
        }
        wCtx.putImageData(wImageData, 0, 0);
        
      }

      window.requestAnimationFrame(renderCanvas);
    }

    function Init() {
      updateStream();
      renderCanvas();

      /*
      
      const constraints = {
          audio: {},
          video: {}
      };
      getStream(constraints).then(getDeviceList).then(loadDevices).catch(handleError);;

      Resize();
      */
    }

    function Resize() {
    }

  </script>
  <style>

    #CurveDisplay
    {
        width : 90%;
        margin-top: 30px;
        margin-bottom: 30px;
        padding-left: 20;
    }

    canvas
    {
        border: 1px solid blue;
        background-color: white;
    }

    #id_video_div {
      /* Video DOM for the camera screen must be visible for the stream to be updated in safari */
      /* If hidden from user, the canvas will not be able to capture the camera picture */
      /* The video is position fixed to the viewpoint to prevent it from falling off screen */
      /* The dimensions of the video needs to be greater than 2px */
      /* The opacity of the video may be set to 0 to be invisible on screen */
      width: 2px;
      height: 2px;
      position: fixed;
      top: 0px;
      left: 0px;
      overflow: hidden;
      opacity: 0.0;
    }
  </style>
  
</HEAD>
<BODY onload="Init()" onresize ="Resize()">
  <div id="main-content-div">
    <select id="id_camera_selection" onchange="updateStream()">
      <option value="user">Front Camera</option>
      <option value="environment"  selected="selected">Back Camera</option>
    </select>
    <div id="id_video_div">
    </div>
    <div id="id_canavas_div">
      <canvas id="id_OutputCanvas"></canvas>
    </div>
    <div id="id_TextOut_div">
    </div>
  </div>
</BODY>
</HTML>
