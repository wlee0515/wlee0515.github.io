<HTML>
<HEAD>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <TITLE>Media Capture Demonstration</TITLE>
  <script type="text/javascript" src="../../global/frame.js"></script>  
  <!--
  <link rel="stylesheet" href="../../css/theme_01.css" />
  -->

  <script>

    var gGlobal = {
      OutputVideoDivId : "id_video_div",
      OutputTextId : "id_TextOut_div",
      InputCameraSelectId : "id_camera_selection",
      OutputCameraVideoId : "id_OutputCameraVideo",
      CurrentCameraStream : null,
      OutputCanvasId : "id_OutputCanvas",
      InternalVideoDOM : null
      }

    function getStream(iConstraints) {
      return navigator.mediaDevices.getUserMedia(iConstraints);
    }

    function getDeviceList() {
      // Only works after "navigator.mediaDevices.getUserMedia(iConstraints)" is called
      return navigator.mediaDevices.enumerateDevices();
    }

    function getDeviceStreamByDeviceId(iDeviceId) {

      const constraints = {
        audio: false,
        video: { deviceId : {exact: iDeviceId} }
      };

      return getStream(constraints);
    }
    
    function getDeviceStreamByFacingMode(iDirection) {

      const constraints = {
        audio: false,
        video: { facingMode: iDirection }
      };

      return getStream(constraints);
    }

    function createLiveVideoDOM() {
      var wNewVideo = document.createElement('video');
      wNewVideo.autoplay = true;
      wNewVideo.setAttribute("muted",null);
      wNewVideo.setAttribute("playsinline",null);    
      wNewVideo.play();  
      return wNewVideo;
    }

    function setVideoDOMStream(iVideoDOM, iNewStream) {
      if (null != iVideoDOM) {
        if (null != iVideoDOM.srcObject) {
          iVideoDOM.srcObject.getTracks().forEach(track => {track.stop();});
        }
        iVideoDOM.srcObject = iNewStream;
      }
    }

    function loadDevices(iDeviceList) {
      
      var wTextOut = document.getElementById(gGlobal.OutputTextId);
      if (null != wTextOut) {
        wTextOut.innerText += JSON.stringify(iDeviceList, null, 2);
      }

      //get Device List
      var wDeviceList = iDeviceList;
      var wDeviceInfoList_audio = [];
      var wDeviceInfoList_video = [];
      
      // Loop through device list
      for (const wDeviceInfo of wDeviceList) {
        var wDevice = {
          Kind : wDeviceInfo.kind,
          Label : wDeviceInfo.label,
          Id : wDeviceInfo.deviceId
        }

        if (wDeviceInfo.kind === 'audioinput') {
          if ("" == wDevice.Label) {
            wDevice.Label = 'Audio ' + (wDeviceInfoList_audio.length + 1);
          }
          wDeviceInfoList_audio.push(wDevice);
        }
        else if (wDeviceInfo.kind === 'videoinput') {
          if ("" == wDevice.Label) {
            wDevice.Label = 'Camera ' + (wDeviceInfoList_audio.length + 1);
          }

          wDeviceInfoList_video.push(wDevice);
        }
      }

      for (var wi = 0; wi < wDeviceInfoList_video.length; ++wi) {
        getDeviceStreamByDeviceId(wDeviceInfoList_video[wi].Id).then(processStream).catch(handleError);
      }
    }

    function processStream(iNewStream) {

      var wVideoDivDom = document.getElementById(gGlobal.OutputVideoDivId);
      if (null != wVideoDivDom) {
        var wNewVideo = createLiveVideoDOM();
        wVideoDivDom.append(wNewVideo);
        setVideoDOMStream(wNewVideo, iNewStream);
      }
    }

    function handleError(iError) {
      alert(iError);
    }

    function changeCurrentStream(iNewStream) {

      var wCameraDOM = document.getElementById(gGlobal.OutputCameraVideoId);
      if(null == wCameraDOM) {
        var wVideoDivDom = document.getElementById(gGlobal.OutputVideoDivId);
        if (null != wVideoDivDom) {
          var wNewVideo = createLiveVideoDOM();
          wNewVideo.id = gGlobal.OutputCameraVideoId;
          wVideoDivDom.append(wNewVideo);
          wCameraDOM = wNewVideo;
        }
      }

      if (null != wCameraDOM) {
        setVideoDOMStream(wCameraDOM, iNewStream);
      }

    }

    
    function changeCurrentStream_Internal(iNewStream) {

      var wCameraDOM = gGlobal.InternalVideoDOM;
      if (null == wCameraDOM) {
        var wNewVideo = createLiveVideoDOM();
        gGlobal.InternalVideoDOM = wNewVideo;
        wCameraDOM = wNewVideo;
      }

      if (null != wCameraDOM) {
        setVideoDOMStream(wCameraDOM, iNewStream);
      }

    }

    function updateStream() {

      var wCameraSelector = document.getElementById(gGlobal.InputCameraSelectId);
      if (null != wCameraSelector) {
        var wCameraFacing = wCameraSelector.options[wCameraSelector.selectedIndex].value;
        getDeviceStreamByFacingMode(wCameraFacing).then(changeCurrentStream_Internal).catch(handleError);
      }
    }
    
    function renderCanvas() {

      var wCameraDOM =  gGlobal.InternalVideoDOM;
      //var wCameraDOM = document.getElementById(gGlobal.OutputCameraVideoId);
      var wCanvasDOM = document.getElementById(gGlobal.OutputCanvasId);
      if((null != wCameraDOM) && (null != wCanvasDOM)) {
        var wHeight = wCameraDOM.videoHeight;
        var wWidth = wCameraDOM.videoWidth;
        
        wCanvasDOM.height = wHeight;
        wCanvasDOM.width = wWidth;
        
        var wCtx = wCanvasDOM.getContext('2d');
	      wCtx.drawImage(wCameraDOM, 0, 0, wWidth, wHeight);
      
      }

      window.requestAnimationFrame(renderCanvas);
    }

    function Init() {
      updateStream();
      renderCanvas();

      /*
      
      const constraints = {
          audio: {},
          video: {}
      };
      getStream(constraints).then(getDeviceList).then(loadDevices).catch(handleError);;

      Resize();
      */
    }

    function Resize() {
      /*
      var wCanvas = document.getElementById(gGlobal.OutputCanvasId);
      var wSize = wCanvas.parentElement.clientWidth;

      wCanvas.height = wSize - 2;
      wCanvas.width = wSize - 2;
      
      updateCurveData();
      */
    }

  </script>
  <style>

    #CurveDisplay
    {
        width : 90%;
        margin-top: 30px;
        margin-bottom: 30px;
        padding-left: 20;
    }

    canvas
    {
        border: 1px solid blue;
        background-color: white;
    }

  </style>
  
</HEAD>
<BODY onload="Init()" onresize ="Resize()">
  <div id="main-content-div">
    <select id="id_camera_selection" onchange="updateStream()">
      <option value="user">Front Camera</option>
      <option value="environment"  selected="selected">Back Camera</option>
    </select>
    <div id="id_video_div">
    </div>
    <div id="id_canavas_div">
      <canvas id="id_OutputCanvas"></canvas>
    </div>
    <div id="id_TextOut_div">
    </div>
    


  <!--
  <div class="select">
    <label for="audioSource">Audio source: </label><select id="audioSource"></select>
  </div>

  <div class="select">
    <label for="videoSource">Video source: </label><select id="videoSource"></select>
  </div>

  <video autoplay muted playsinline></video>
  

  <script>
  
var videoElement = document.querySelector('video');
var audioSelect = document.querySelector('select#audioSource');
var videoSelect = document.querySelector('select#videoSource');

audioSelect.onchange = getStream;
videoSelect.onchange = getStream;

getStream().then(getDevices).then(gotDevices);

function getDevices() {
  // AFAICT in Safari this only gets default devices until gUM is called :/
  return navigator.mediaDevices.enumerateDevices();
}

function gotDevices(deviceInfos) {
  window.deviceInfos = deviceInfos; // make available to console
  console.log('Available input and output devices:', deviceInfos);
  for (const deviceInfo of deviceInfos) {
    const option = document.createElement('option');
    option.value = deviceInfo.deviceId;
    if (deviceInfo.kind === 'audioinput') {
      option.text = deviceInfo.label || `Microphone ${audioSelect.length + 1}`;
      audioSelect.appendChild(option);
    } else if (deviceInfo.kind === 'videoinput') {
      option.text = deviceInfo.label || `Camera ${videoSelect.length + 1}`;
      videoSelect.appendChild(option);
    }
  }
}

function getStream() {
  if (window.stream) {
    window.stream.getTracks().forEach(track => {
      track.stop();
    });
  }
  const audioSource = audioSelect.value;
  const videoSource = videoSelect.value;
  const constraints = {
    audio: {deviceId: audioSource ? {exact: audioSource} : undefined},
    video: {deviceId: videoSource ? {exact: videoSource} : undefined}
  };
  return navigator.mediaDevices.getUserMedia(constraints).
    then(gotStream).catch(handleError);
}

function gotStream(stream) {
  window.stream = stream; // make stream available to console
  audioSelect.selectedIndex = [...audioSelect.options].
    findIndex(option => option.text === stream.getAudioTracks()[0].label);
  videoSelect.selectedIndex = [...videoSelect.options].
    findIndex(option => option.text === stream.getVideoTracks()[0].label);
  videoElement.srcObject = stream;
}

function handleError(error) {
  console.error('Error: ', error);
}

  </script>
  <video id="video" width="640" height="480" autoplay></video>
  <button id="snap">Snap Photo</button>
  <canvas id="canvas" width="640" height="480"></canvas>
  <script>
  // Grab elements, create settings, etc.
var video = document.getElementById('video');

// Get access to the camera!
if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    // Not adding `{ audio: true }` since we only want video now
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
        //video.src = window.URL.createObjectURL(stream);
        video.srcObject = stream;
        video.play();
    });
}
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');
var video = document.getElementById('video');

// Trigger photo take
document.getElementById("snap").addEventListener("click", function() {
	context.drawImage(video, 0, 0, 640, 480);
});


  </script>
-->
  </div>
</BODY>
</HTML>
