<HTML>
<HEAD>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <TITLE>Camera Capture Demo</TITLE>
  <script type="text/javascript" src="../../global/frame.js"></script>  
  <!--
  <link rel="stylesheet" href="../../css/theme_01.css" />
  -->

  <script>

    var gGlobal = {
      OutputVideoDivId : "id_video_div",
      OutputTextId : "id_TextOut_div",
      InputCameraSelectId : "id_camera_selection",
      OutputCameraVideoId : "id_OutputCameraVideo",
      CurrentCameraStream : null,
      OutputCanvasId : "id_OutputCanvas",
      InternalCanvasDOM : null
      }

    function getStream(iConstraints) {
      return navigator.mediaDevices.getUserMedia(iConstraints);
    }

    function getDeviceList() {
      // Only works after "navigator.mediaDevices.getUserMedia(iConstraints)" is called
      return navigator.mediaDevices.enumerateDevices();
    }

    function getDeviceStreamByDeviceId(iDeviceId) {

      const constraints = {
        audio: false,
        video: { deviceId : {exact: iDeviceId} }
      };

      return getStream(constraints);
    }
    
    function getDeviceStreamByFacingMode(iDirection) {

      const constraints = {
        audio: false,
        video: { facingMode: {exact: iDirection}}
      };

      return getStream(constraints);
    }

    function createLiveVideoDOM() {
      var wNewVideo = document.createElement('video');
      wNewVideo.autoplay = true;
      wNewVideo.setAttribute("muted",null);
      wNewVideo.setAttribute("playsinline",null);    
      return wNewVideo;
    }

    function setVideoDOMStream(iVideoDOM, iNewStream) {
      if (null != iVideoDOM) {
        if (null != iVideoDOM.srcObject) {
          iVideoDOM.srcObject.getTracks().forEach(track => {track.stop();});
        }
        iVideoDOM.srcObject = iNewStream;
      }
    }

    function loadDevices(iDeviceList) {
      
      var wTextOut = document.getElementById(gGlobal.OutputTextId);
      if (null != wTextOut) {
        wTextOut.innerText += JSON.stringify(iDeviceList, null, 2);
      }

      //get Device List
      var wDeviceList = iDeviceList;
      var wDeviceInfoList_audio = [];
      var wDeviceInfoList_video = [];
      
      // Loop through device list
      for (const wDeviceInfo of wDeviceList) {
        var wDevice = {
          Kind : wDeviceInfo.kind,
          Label : wDeviceInfo.label,
          Id : wDeviceInfo.deviceId
        }

        if (wDeviceInfo.kind === 'audioinput') {
          if ("" == wDevice.Label) {
            wDevice.Label = 'Audio ' + (wDeviceInfoList_audio.length + 1);
          }
          wDeviceInfoList_audio.push(wDevice);
        }
        else if (wDeviceInfo.kind === 'videoinput') {
          if ("" == wDevice.Label) {
            wDevice.Label = 'Camera ' + (wDeviceInfoList_audio.length + 1);
          }

          wDeviceInfoList_video.push(wDevice);
        }
      }

      for (var wi = 0; wi < wDeviceInfoList_video.length; ++wi) {
        getDeviceStreamByDeviceId(wDeviceInfoList_video[wi].Id).then(processStream).catch(handleError);
      }
    }

    function processStream(iNewStream) {

      var wVideoDivDom = document.getElementById(gGlobal.OutputVideoDivId);
      if (null != wVideoDivDom) {
        var wNewVideo = createLiveVideoDOM();
        wVideoDivDom.append(wNewVideo);
        setVideoDOMStream(wNewVideo, iNewStream);
      }
    }

    function handleError(iError) {
      alert(iError);
    }

    function changeCurrentStream(iNewStream) {

      var wCameraDOM = document.getElementById(gGlobal.OutputCameraVideoId);
      if(null == wCameraDOM) {
        var wVideoDivDom = document.getElementById(gGlobal.OutputVideoDivId);
        if (null != wVideoDivDom) {
          var wNewVideo = createLiveVideoDOM();
          wNewVideo.id = gGlobal.OutputCameraVideoId;
          wVideoDivDom.append(wNewVideo);
          wCameraDOM = wNewVideo;
        }
      }

      if (null != wCameraDOM) {
        setVideoDOMStream(wCameraDOM, iNewStream);
      }

    }

    function updateStream() {

      var wCameraSelector = document.getElementById(gGlobal.InputCameraSelectId);
      if (null != wCameraSelector) {
        var wCameraFacing = wCameraSelector.options[wCameraSelector.selectedIndex].value;
        getDeviceStreamByFacingMode(wCameraFacing).then(changeCurrentStream).catch(handleError);
      }
    }

    function putVideoInCanvas(iVideoDOM, iCanvasDOM) {
      if((null != iVideoDOM) && (null != iCanvasDOM)) {
        var wVideoHeight = iVideoDOM.videoHeight;
        var wVideoWidth = iVideoDOM.videoWidth;
        iCanvasDOM.height = wVideoHeight;
        iCanvasDOM.width = wVideoWidth;

        var wCtx = iCanvasDOM.getContext('2d');
	      wCtx.drawImage(iVideoDOM, 0, 0, wVideoWidth, wVideoHeight);
      }  
    }

    function applyCanvasFilter_InvertChecker(iCanvasDOM) {
      
      var wCtx = iCanvasDOM.getContext('2d');	  
      var wImageDataWidth = iCanvasDOM.width;
      var wImageDataHeight = iCanvasDOM.height;

      var wImageData = wCtx.getImageData(0, 0, wImageDataWidth,wImageDataHeight);
      var wData = wImageData.data;

      for (var wi = 0; wi < wImageDataHeight; ++wi) {
        for (var wj = 0; wj < wImageDataWidth; ++wj) {
          var wInvert = false;

          if (wj > wImageDataWidth / 2) {
            if (wi > wImageDataHeight / 2) {
              wInvert = true;
            }
          }
          else {
            if (wi < wImageDataHeight / 2) {
              wInvert = true;
            }
          }
          if (true == wInvert) {

            var wIndex = (wi * wImageDataWidth + wj) * 4;
            wData[wIndex] = 255 - wData[wIndex];     // red
            wData[wIndex + 1] = 255 - wData[wIndex + 1]; // green
            wData[wIndex + 2] = 255 - wData[wIndex + 2]; // blue
          }
        }
      }
      wCtx.putImageData(wImageData, 0, 0);
    }

    function stretchAndCenterCanvas(iSourceCanvasDOM, iDestinationCanvasDOM) {
      var wDestWidth = iDestinationCanvasDOM.width;
      var wDestHeight = iDestinationCanvasDOM.height;

      var wSrcHeight = iSourceCanvasDOM.height;
      var wSrcWidth = iSourceCanvasDOM.width;
      var wSrcTop = 0;
      var wSrcLeft = 0;

      var wScale = wDestHeight/wSrcHeight;
      if (wScale*wSrcWidth < wDestWidth) {
        wScale = wDestWidth/wSrcWidth;
      }
      wSrcHeight *= wScale;
      wSrcWidth *= wScale;
      wSrcTop = - (wSrcHeight - wDestHeight)/2;
      wSrcLeft = - (wSrcWidth - wDestWidth)/2;

      var wCtx = iDestinationCanvasDOM.getContext('2d');
	    wCtx.drawImage(iSourceCanvasDOM, wSrcLeft, wSrcTop, wSrcWidth, wSrcHeight);
      
    }

    function renderCanvas() {

      var wTempCanvasDOM = gGlobal.InternalCanvasDOM;
      if (null == wTempCanvasDOM) {
        wTempCanvasDOM = document.createElement('canvas');
      }

      //var wCameraDOM =  gGlobal.InternalVideoDOM;
      var wCameraDOM = document.getElementById(gGlobal.OutputCameraVideoId);

      var wCanvasDOM = document.getElementById(gGlobal.OutputCanvasId);
      if((null != wCameraDOM) && (null != wCanvasDOM)) {
        if(0 != wCameraDOM.videoWidth) {
          
          putVideoInCanvas(wCameraDOM, wTempCanvasDOM);
          applyCanvasFilter_InvertChecker(wTempCanvasDOM);
          stretchAndCenterCanvas(wTempCanvasDOM, wCanvasDOM);
          
        }
        
      }

      window.requestAnimationFrame(renderCanvas);
    }

    function Init() {
      updateStream();
      renderCanvas();

      Resize();
      /*
      
      const constraints = {
          audio: {},
          video: {}
      };
      getStream(constraints).then(getDeviceList).then(loadDevices).catch(handleError);;

      Resize();
      */
    }

    function Resize() {
      var wCanvasDOM = document.getElementById(gGlobal.OutputCanvasId);
      if(null != wCanvasDOM) {
        wCanvasDOM.height = wCanvasDOM.parentNode.clientHeight;
        wCanvasDOM.width = wCanvasDOM.parentNode.clientWidth;
      }
    }

  </script>
  <style>

    #CurveDisplay
    {
        width : 90%;
        margin-top: 30px;
        margin-bottom: 30px;
        padding-left: 20;
    }

    canvas
    {
        border: 1px solid blue;
        background-color: white;
    }

    #id_video_div {
      /* Video DOM for the camera screen must be visible for the stream to be updated in safari */
      /* If hidden from user, the canvas will not be able to capture the camera picture */
      /* The video is position fixed to the viewpoint to prevent it from falling off screen */
      /* The dimensions of the video needs to be greater than 2px */
      /* The opacity of the video may be set to 0 to be invisible on screen */
      width: 50px;
      height: 50px;
      position: fixed;
      top: 0px;
      left: 0px;
      overflow: hidden;
      opacity: 0.0;
    }

    #id_canavas_div{
      position: fixed;
      top: 0px;
      left: 0px;
      z-index: -1000;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

  </style>
  
</HEAD>
<BODY onload="Init()" onresize ="Resize()">
  <div id="main-content-div">
    <select id="id_camera_selection" onchange="updateStream()">
      <option value="user" selected="selected">Front Camera</option>
      <option value="environment">Back Camera</option>
    </select>
    <div id="id_video_div">
    </div>
    <div id="id_canavas_div">
      <canvas id="id_OutputCanvas"></canvas>
    </div>
    <div id="id_TextOut_div">
    </div>
  </div>
</BODY>
</HTML>
