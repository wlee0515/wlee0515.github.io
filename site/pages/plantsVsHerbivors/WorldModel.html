<html>
<head>
  <meta name="description" content="A Demonstration of an Artificial world simulation with Dave Ackley's Plants vs Herbivors applete programmed by Wilson Lee @Heap Art">
  <meta name="keywords" content="Heap Art, artificial life, life simulation, Plants vs Herbivors, Dave Ackley, Wilson Lee">
  <meta name="author" content="Wilson Lee @Heap Art">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <Title>Heap Art - Prism Phone Stand</Title>
  <style>
      body {
        padding: 0;
        margin: 0;
        overflow: hidden;
      }

      #id_SubCount {
        height : 110px;
        width : 350px;
        overflow : hidden;
        scroll-behavior : none;
      }
      
      #id_SimulationViewPoint_div {
        padding: 0;
        margin: 0;
        z-index: -100;
        width: 100vw;
        height: 100vh;
        background-color: black;
      }

      canvas
      {
        border: 1px solid blue;
      }

  </style>
  <script>

      //---------------------------------------------------------------
      // Helper Functions
      //---------------------------------------------------------------
      
      function getImgPixelData(iCanvas) {

        var wInputWidth =  iCanvas.width;
        var wInputHeight =  iCanvas.height;
        var wInputCtx =  iCanvas.getContext('2d');
        const wInputImageData = wInputCtx.getImageData(0, 0, wInputWidth, wInputHeight);
        const wInputPixelArray = wInputImageData.data;

        return {
          width : wInputWidth,
          height : wInputHeight,
          ctx : wInputCtx,
          imageData : wInputImageData,
          pixelArray : wInputPixelArray
        }
      }

      function driftColor(iNumber) {
          var wNewColor = iNumber + Math.round(2*Math.random() - 1);
          if (wNewColor > 255) wNewColor=255;
          else if (wNewColor < 0) wNewColor = 0;
          return wNewColor;
      }

      //---------------------------------------------------------------
      // Global Variables
      //---------------------------------------------------------------
      
      eCanvas_Layer = {
        Lightning : 0,
        Plants : 1,
        Herbivors : 2,
      }

      gWorldModel = {
        DisplayCanvas : null,
        CanvasLayer : [],
        SpriteScale : 5,
        Counts : [],

        DisplayLayers : [],
        SpriteImg:{}
      }

      //---------------------------------------------------------------
      // Global Variables
      //---------------------------------------------------------------

      window.addEventListener("load", function(){
        setup();
        setInterval(iteration, 25);
      })

      function setup() {

        var wSimulationViewPoint = document.getElementById("id_SimulationViewPoint_canvas");
        if (null != wSimulationViewPoint) {
          gWorldModel.DisplayCanvas = wSimulationViewPoint;
        }

        var wWorldLayers = Object.keys(eCanvas_Layer);
        for(var wi = 0; wi < wWorldLayers.length; ++wi) {
          gWorldModel.CanvasLayer.push(document.createElement("canvas"));
          gWorldModel.Counts.push(0);
        }

        gWorldModel.DisplayLayers = Object.keys(eCanvas_Layer);


        gWorldModel.SpriteImg["Lightning"] = [[0,0,0,1,0]
                                             ,[0,0,1,0,0]
                                             ,[0,1,1,1,0]
                                             ,[0,0,1,0,0]
                                             ,[0,1,0,0,0]]
                                            
        gWorldModel.SpriteImg["Plants"]    = [[0.3,1.0,0.5,1.0,0.3]
                                             ,[1.0,0.3,0.7,0.3,1.0]
                                             ,[0.5,0.7,1.0,0.7,0.5]
                                             ,[1.0,0.3,0.7,0.3,1.0]
                                             ,[0.3,1.0,0.5,1.0,0.3]]


        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
      }

      
      function resizeCanvas() {
        if (null != gWorldModel.DisplayCanvas ) {

          var wWorldDisplayWidth = gWorldModel.DisplayCanvas.parentElement.clientWidth;
          var wWorldDisplayHeight = gWorldModel.DisplayCanvas.parentElement.clientHeight;

          gWorldModel.DisplayCanvas.width = wWorldDisplayWidth;
          gWorldModel.DisplayCanvas.height = wWorldDisplayHeight;

          var wWorldWidth = Math.ceil(wWorldDisplayWidth/gWorldModel.SpriteScale);
          var wWorldHeight = Math.ceil(wWorldDisplayHeight/gWorldModel.SpriteScale);
          
          var wWorldLayers = Object.keys(eCanvas_Layer);
          for(var wi = 0; wi < wWorldLayers.length; ++wi) {
            var wKey = eCanvas_Layer[wWorldLayers[wi]];
            gWorldModel.CanvasLayer[wKey].width = wWorldWidth;
            gWorldModel.CanvasLayer[wKey].height = wWorldHeight;
          }
        }
      }


      function iteration () {

        process();
        render();
      }

      function process() {

        var wLightningImg = getImgPixelData(gWorldModel.CanvasLayer[eCanvas_Layer.Lightning])
        var wPlantsImg = getImgPixelData(gWorldModel.CanvasLayer[eCanvas_Layer.Plants])
        var wHerbivorsImg = getImgPixelData(gWorldModel.CanvasLayer[eCanvas_Layer.Herbivors])

        var wInputWidth = wLightningImg.width;
        var wInputHeight = wLightningImg.height;
        var wIndex = 0;
        for(var wX = 0; wX < wInputWidth; ++wX) {

          for(var wY = 0; wY < wInputHeight; ++wY) {
            wIndex = (wY*wInputWidth + wX)*4;
            wTargetIndex = ((wY+Math.round(2*Math.random() - 1))*wInputWidth + (wX+Math.round(2*Math.random() - 1)))*4;

            wALightning = wLightningImg.pixelArray[wIndex + 3];
            wTALightning = wLightningImg.pixelArray[wTargetIndex + 3];
            
            wAPlant = wPlantsImg.pixelArray[wIndex + 3];
            wTAPlant = wPlantsImg.pixelArray[wTargetIndex + 3];
            
            wAHerbivor = wHerbivorsImg.pixelArray[wIndex + 3];
            wTAHerbivor = wHerbivorsImg.pixelArray[wTargetIndex + 3];

            if (0 != wALightning) {
              var wNewLightning = Math.floor(0.75* wLightningImg.pixelArray[wIndex + 3]);
              wALightning = wLightningImg.pixelArray[wIndex + 3] = wNewLightning;
            }
            else {
              if(Math.random() < 0.0001) {
                wALightning = wLightningImg.pixelArray[wIndex + 3] = 255;
                wLightningImg.pixelArray[wIndex]     = 255; // red
                wLightningImg.pixelArray[wIndex + 1] = 255; // green
                wLightningImg.pixelArray[wIndex + 2] = 0; // blue
              }

            }


            if (0 != wAPlant) {
              if (0 == wALightning) {
                if (wAPlant <255) {
                  wAPlant = wPlantsImg.pixelArray[wIndex + 3] = wAPlant +=1;
                }
                else {
                  if (0 == wTALightning) {
                    if (0 == wTAPlant) {
                      if (0 == wTAHerbivor) {
                        wTAPlant = wPlantsImg.pixelArray[wTargetIndex + 3] = 1;
                        wPlantsImg.pixelArray[wTargetIndex] = driftColor(wPlantsImg.pixelArray[wIndex]); // red
                        wPlantsImg.pixelArray[wTargetIndex + 1] = driftColor(wPlantsImg.pixelArray[wIndex + 1]); // green
                        wPlantsImg.pixelArray[wTargetIndex + 2] = driftColor(wPlantsImg.pixelArray[wIndex + 2]); // blue
                        wAPlant = wPlantsImg.pixelArray[wIndex + 3] = 100;
                      }
                    }
                  }
                }

              }
              else {
                wAPlant = wPlantsImg.pixelArray[wIndex + 3] = 0;
              }
            }
            else {
              
              if (0 == wALightning) {
                if (Math.random() < 0.0000001) {
                  wAPlant = wPlantsImg.pixelArray[wIndex + 3] = 1;
                  wPlantsImg.pixelArray[wIndex] = Math.round(Math.random() * 255); // red
                  wPlantsImg.pixelArray[wIndex + 1] = Math.round(Math.random() * 255); // green
                  wPlantsImg.pixelArray[wIndex + 2] = Math.round(Math.random() * 255); // blue
                }
              }
            }

          }
        }
        
        wLightningImg.ctx.putImageData(wLightningImg.imageData, 0, 0);
        wPlantsImg.ctx.putImageData(wPlantsImg.imageData, 0, 0);
        wHerbivorsImg.ctx.putImageData(wHerbivorsImg.imageData, 0, 0);
      }


      function render() {

        if (null == gWorldModel.DisplayCanvas) {
          return;
        }

        var wCtx =  gWorldModel.DisplayCanvas.getContext('2d');
        wCtx.clearRect(0,0,gWorldModel.DisplayCanvas.width, gWorldModel.DisplayCanvas.height);

        for(var wi = 0; wi < gWorldModel.DisplayLayers.length; ++wi) {

            var wEnum = gWorldModel.DisplayLayers[wi];
            var wKey = eCanvas_Layer[wEnum];
            var wInputLayer = gWorldModel.CanvasLayer[wKey];
            var wSprite = gWorldModel.SpriteImg[wEnum];

            drawWorldElements(gWorldModel.DisplayCanvas, wInputLayer, wSprite)
        }        
      }

      function drawWorldElements(iDisplayCanvas, iElementCanvas, iDrawArray) {

        if ((null ==iDrawArray) || (null == iDisplayCanvas) || (null == iElementCanvas)) {
          return;
        }

        var wInputImg = getImgPixelData(iElementCanvas);
        var wOutputImg = getImgPixelData(iDisplayCanvas);

        var wScale = Math.round( wOutputImg.width/wInputImg.width);

        var wIndex = 0;
        for(var wX = 0; wX < wInputImg.width; ++wX) {

          for(var wY = 0; wY < wInputImg.height; ++wY) {
            wIndex = (wY*wInputImg.width + wX)*4;
            wA = wInputImg.pixelArray[wIndex + 3]; // alpha
            if (0 != wA) {
              wR = wInputImg.pixelArray[wIndex] ; // red
              wG = wInputImg.pixelArray[wIndex + 1]; // green
              wB = wInputImg.pixelArray[wIndex + 2]; // blue

              var wDrawAnchorX = wX*wScale;
              var wDrawAnchorY = wY*wScale;

              var wOX,wOY,wOIndex;

              for (var wSY = 0; wSY < iDrawArray.length; ++wSY) {
                wOY = wDrawAnchorY + wSY;
                for (var wSX = 0; wSX < iDrawArray[wSY].length; ++wSX) {
                  wOX = wDrawAnchorX + wSX;
                  wOIndex = (wOY * wOutputImg.width + wOX) * 4;

                  wOutputImg.pixelArray[wOIndex] = wR;
                  wOutputImg.pixelArray[wOIndex + 1] = wG;
                  wOutputImg.pixelArray[wOIndex + 2] = wB;

                  wOAlpha = (wA) * iDrawArray[wSY][wSX];
                  wOAlpha = wOAlpha > 255 ? 255 : wOAlpha < 0 ? 0 : wOAlpha;
                  wOutputImg.pixelArray[wOIndex + 3] = wOAlpha;

                }
              }
            }
          }
        }
        /*
        for (var wX = 0; wX < wOutputImg.width; ++wX) {

          for (var wY = 0; wY < wOutputImg.height; ++wY) {
            wIndex = (wY * wOutputImg.width + wX) * 4;
            wOutputImg.pixelArray[wIndex + 3] = 255; // alpha
            wOutputImg.pixelArray[wIndex] = Math.floor(255*wX/wOutputImg.width) ; // red
            wOutputImg.pixelArray[wIndex + 1] = 0; // green
            wOutputImg.pixelArray[wIndex + 2] = Math.floor(255*wY/wOutputImg.height); // blue


          }
        }

*/

        wOutputImg.ctx.putImageData(wOutputImg.imageData, 0, 0);
      }

  </script>
</head>
<body>
  <!--
    <iframe id="id_SubCount" frameborder="0" src="https://freewebtools.com/live-sub-count/Heap%20Art/" allowfullscreen></iframe>
  -->
  <div id="id_SimulationViewPoint_div">
    <canvas id="id_SimulationViewPoint_canvas"></canvas>
  </div>
</body>

</html>
