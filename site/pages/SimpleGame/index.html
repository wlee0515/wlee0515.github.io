<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Simple Game</title>
  <script>
    var gFramePosition = 1;
  </script>
  <script type="text/javascript" src="../../global/frame.js"></script>
  <script type="text/javascript" src="../../thirdparty/ThreeJS/three.js"></script>
  <script type="text/javascript" src="../../thirdparty/ThreeJS/js/loaders/GLTFLoader.js"></script>
  <script type="text/javascript" src="http://webrti.herokuapp.com/script/javascript/utility.js"></script>
  <script type="text/javascript" src="http://webrti.herokuapp.com/script/javascript/WebRTI.js"></script>
  <script type="text/javascript" src="http://webrti.herokuapp.com/script/javascript/socket.io-1.2.0.js"></script>
  <script>
    var gGlobal = {
      Time : {
        LastTimeStamp : (new Date()).getTime()
      },
      
      ControlInput : {
        JoyStick1 : null,
        JoyStick2 : null,
        OutputDiv_J1_id : "id_JoyStick_1",
        OutputDiv_J2_id : "id_JoyStick_2",
      },

      ViewPoint : {
        CanvasId : "id_OutputCanvas",
        Scene : null,
  			Camera : null,
        Renderer : null,
        LoaderList : [],
        MixerList : [],
      },

      Planet : {
        Radius : 6371000,
        DrawRadius : 1000
      },

      Ownship : {
        location : [0.0,0.0,0.0],
        eulerAngle : [0.0,0.0,0.0]
      },

      socket: null,
      webRTI : null,

      EntityManager : null,
      placeHolder : 0
    }

    function convertGeoLocationToCartesian (iLatitude, iLongitude, iAltitude ) {
      
      var wLatitude = iLatitude*(Math.PI/180);
      var wLongitude = iLongitude*(Math.PI/180);

      var wRadius = (iAltitude + gGlobal.Planet.Radius)*(gGlobal.Planet.DrawRadius/gGlobal.Planet.Radius);
      var wEquatorRadius = wRadius*Math.cos(wLatitude);
      
      return {
        y : wRadius*Math.sin(wLatitude),
        x : wEquatorRadius*Math.sin(iLatitude),
        z : wEquatorRadius*Math.cos(iLongitude)
      }
    }

    function getEulerQuaternion (iLatitude, iLongitude, iRoll, iPitch, iYaw ) {
      
			var wQuat1 = new THREE.Quaternion();
			var wRefEuler = new THREE.Euler(-iLatitude + Math.PI/2, iLongitude, 0, "ZYX" );
			wQuat1.setFromEuler(wRefEuler);

			var wQuat2 = new THREE.Quaternion();
			var wLocalEuler = new THREE.Euler( iPitch,-iYaw, -iRoll, "YXZ" );
			wQuat2.setFromEuler(wLocalEuler);

			wQuat1.multiply(wQuat2);
      
      return wQuat1;
    }


    function EntityManager() {
      this.EntityList = {};
      
      this.generateEntityIdString = function (iSource, id ) {
        return iSource + ' - ' + id;
      }

      this.createEntity = function (iEntityId) {
        if (null == this.EntityList[iEntityId]) {
          var wGeometry = new THREE.BoxGeometry(1, 1, 1);
          var wMaterial = new THREE.MeshLambertMaterial({ color: hashCode(iEntityId) });
          var wMesh = new THREE.Mesh(wGeometry, wMaterial);

          gGlobal.ViewPoint.Scene.add(wMesh);

          this.EntityList[iEntityId] = {
            isUpdated : false,
            geometry : wGeometry,
            material : wMaterial,
            mesh : wMesh,
            model : null,
            modelPath : ""
          }
        }
      }
      
      this.removeEntity = function (iEntityId) {
        var wEntity = this.EntityList[iEntityId];
        if (null != wEntity) {
          
          gGlobal.ViewPoint.Scene.remove( wEntity.mesh );
          wEntity.geometry.dispose();
          wEntity.material.dispose();
          
          if (null != wEntity.model) {
            gGlobal.ViewPoint.Scene.remove( wEntity.model );
          }

          delete this.EntityList[iEntityId];
        }
      }

      
      this.getEntity = function (iEntityId) {
        this.createEntity(iEntityId);
        return this.EntityList[iEntityId];
      }

      this.removeNoneUpdated = function() {
        var wEntries = Object.entries(this.EntityList);
        for (var wi=0; wi < wEntries.length; ++wi) {
          var wEntry = wEntries[wi];
          if (true == wEntry[1].isUpdated) {
            wEntry[1].isUpdated = false;
          }
          else {
            this.removeEntity(wEntry[0]);
          }
        }
      }

      this.setEntityPosition = function (iEntityId, iLocation, iEuler) {

        var wPosition = convertGeoLocationToCartesian(iLocation[0],iLocation[1],iLocation[2]);

        var wEulerQuat = getEulerQuaternion(iLocation[0],iLocation[1], iEuler[0],iEuler[1],iEuler[2]);

        var wEntity = this.getEntity(iEntityId);
        wEntity.isUpdated = true;
        wEntity.mesh.position.set(wPosition.x, wPosition.y, wPosition.z);
        wEntity.mesh.rotation.setFromQuaternion(wEulerQuat);

        if (null != wEntity.model) {
          wEntity.model.position.set(wPosition.x, wPosition.y, wPosition.z);
          wEntity.model.rotation.setFromQuaternion(wEulerQuat);
        }

      }

      this.setEntityModel = function (iEntityId, iModelPath) {
        
        var wEntity = this.EntityList[iEntityId];
        if (null == wEntity) {
          return;
        }

        wEntity.isUpdated = true;
        if (wEntity.modelPath == iModelPath) {
          return;
        }
        
        var wEntityId = iEntityId;
        wEntity.modelPath = iModelPath;

        gGlobal.ViewPoint.LoaderList["gltf"].load(iModelPath, function (iModelData) {
          if (0 != iModelData.animations.length) {
            var wMixer = new THREE.AnimationMixer(iModelData.scene);
            var wAction = wMixer.clipAction(iModelData.animations[0]);
            wAction.play();
            gGlobal.ViewPoint.MixerList.push(wMixer);
          }

          var wEntity = this.EntityList[wEntityId];

          if (null != wEntity) {

            if (null != wEntity.model) {
              wEntity.model.dispose();
            }

            wEntity.model = iModelData.scene;
            wEntity.model.position.set(0.0, 0.0, 0.0);
            wEntity.model.rotation.set(0, 0, 0);
            wEntity.mesh.visible = false;
            gGlobal.ViewPoint.Scene.add(wEntity.model);
          }
          else {
            iModelData.dispose();
          }
        }.bind(this))
      }
    }


    function setupViewPoint() {
			gGlobal.ViewPoint.Scene = new THREE.Scene();
			gGlobal.ViewPoint.Camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 100000 );
			gGlobal.ViewPoint.Camera.position.set( 0, 0, 20 );
			gGlobal.ViewPoint.Camera.lookAt( 0, 0, 0 );

			var wCanvasDOM = document.getElementById(gGlobal.ViewPoint.CanvasId);
			if (null != wCanvasDOM) {
				gGlobal.ViewPoint.Renderer = new THREE.WebGLRenderer({antialias: true, canvas:  wCanvasDOM,  alpha: true });
			}
			else {
				gGlobal.ViewPoint.Renderer = new THREE.WebGLRenderer({antialias: true,  alpha: true });
				document.body.appendChild( gGlobal.ViewPoint.Renderer.domElement );
      }
      gGlobal.ViewPoint.Renderer.setClearColor( 0x000000, 0 );
			gGlobal.ViewPoint.Renderer.setPixelRatio( window.devicePixelRatio );

      gGlobal.ViewPoint.Renderer.toneMapping = THREE.LinearToneMapping;
      gGlobal.ViewPoint.Renderer.toneMappingExposure = Math.pow( 0.94, 5.0 );
      gGlobal.ViewPoint.Renderer.shadowMap.enabled = true;
      gGlobal.ViewPoint.Renderer.shadowMap.type = THREE.PCFShadowMap;

      var wGLTFloader = new THREE.GLTFLoader();
      wGLTFloader.crossOrigin = true;
      gGlobal.ViewPoint.LoaderList["gltf"] = wGLTFloader;

      var resizeFunction = function(){

				if (null != gGlobal.ViewPoint.Renderer) {
					var wWidth = window.innerWidth;
					var wHeight = window.innerHeight;
					var wCanvasDOM = document.getElementById(gGlobal.ViewPoint.CanvasId);
					if (null != wCanvasDOM) {
					  wWidth = wCanvasDOM.width = wCanvasDOM.parentNode.clientWidth;
					  wHeight = wCanvasDOM.height = wCanvasDOM.parentNode.clientHeight;
					}
					gGlobal.ViewPoint.Renderer.setSize(wWidth, wHeight);
	
					if (null != gGlobal.ViewPoint.Camera) {
						gGlobal.ViewPoint.Camera.aspect = wWidth / wHeight;
						gGlobal.ViewPoint.Camera.updateProjectionMatrix();
					}
				}
      }
      
      resizeFunction();
      window.addEventListener("resize", resizeFunction);
    }

    function loadGLTF(iPath) {
      gGlobal.ViewPoint.LoaderList["gltf"].load( iPath, function ( iModelData ) {
    /*    
        iModelData.animations; // Array<THREE.AnimationClip>
        iModelData.scene; // THREE.Scene
		    iModelData.scenes; // Array<THREE.Scene>
        iModelData.cameras; // Array<THREE.Camera>
        iModelData.asset; // Object
  */
        if (0 != iModelData.animations.length) {
          var wMixer = new THREE.AnimationMixer( iModelData.scene );
	        var wAction = wMixer.clipAction( iModelData.animations[ 0 ] );
          wAction.play();
          gGlobal.ViewPoint.MixerList.push(wMixer);
        }
  
        var wModel = iModelData.scene;
//        wModel.position.set(-1.0, -10.5, -1.0);
        wModel.position.set(0.0, 0.0, 0.0);
        wModel.rotation.set(0, 0, 0);
//        wModel.scale.set(0.05,0.05,0.05);

        var wGroup = new THREE.Group();
        wGroup.add( wModel );
        wGroup.position.set(-5.0, 0, 0.0);
        wGroup.name = "Model";
        gGlobal.ViewPoint.Scene.add( wGroup );

      });
    }

    function setupScene() {
      
      var light = new THREE.PointLight( 0xffffcc, 10, 50, 2 );
      light.position.set( 4, 30, -20 );
      gGlobal.ViewPoint.Scene.add( light );

      var light2 = new THREE.AmbientLight( 0x20202A, 10 );
      light2.position.set( 30, -10, 30 );
      gGlobal.ViewPoint.Scene.add( light2 );

      gGlobal.ViewPoint.Scene.add( new THREE.HemisphereLight( 0xffffbb, 0x080820, 0.01 ) );
      gGlobal.ViewPoint.Scene.add(new THREE.DirectionalLight( 0xffffff, 0.1 ));
      

      // Setup Planet      
      var wPlanetGeometry = new THREE.SphereGeometry( gGlobal.Planet.DrawRadius - 0.5, 360, 180 );
      var wPlanetMaterial = new THREE.MeshLambertMaterial( {color: 0x0000EE} );
      var wPlanet = new THREE.Mesh( wPlanetGeometry, wPlanetMaterial );
      wPlanet.name = "PlanetWater";

      var wPlanetWireframeGeometryBuffer = new THREE.SphereBufferGeometry( gGlobal.Planet.DrawRadius, 360, 180 );
      var wPlanetWireframeGeometry = new THREE.WireframeGeometry( wPlanetWireframeGeometryBuffer );
      var wPlanetWireframeMaterial = new THREE.LineBasicMaterial( { color: 0xffffff, linewidth: 10 } );
      var wPlanetWireframe = new THREE.LineSegments( wPlanetWireframeGeometry, wPlanetWireframeMaterial );
      wPlanetWireframe.material.depthTest = true;
      wPlanetWireframe.material.opacity = 0.50;
      wPlanetWireframe.material.transparent = true;
      wPlanetWireframe.name = "PlanetWireframe";

      
      var wPlanetGroup = new THREE.Group();
      wPlanetGroup.add( wPlanet );
      wPlanetGroup.add( wPlanetWireframe );
      wPlanetGroup.name = "Planet";

      gGlobal.ViewPoint.Scene.add( wPlanetGroup );


      //loadGLTF("../../thirdparty/sampleGLFT/2.0/VC/glTF/VC.gltf")
      loadGLTF('https://threejsfundamentals.org/threejs/resources/models/cartoon_lowpoly_small_city_free_pack/scene.gltf')
      
    }

    function updateScene(iDt) {
      
      for (var wi = 0; wi < gGlobal.ViewPoint.MixerList.length; ++wi) {
        gGlobal.ViewPoint.MixerList[wi].update(iDt);
      }

			gGlobal.ViewPoint.Renderer.render(gGlobal.ViewPoint.Scene, gGlobal.ViewPoint.Camera);
    }
    
    function updateJoystick(iDt) {
      
      var wJ1_State = { x:0,y:0,z:0};
      var wJ2_State = { x:0,y:0,z:0};

      if (null != gGlobal.ControlInput.JoyStick1) {
        wJ1_State = gGlobal.ControlInput.JoyStick1.getAxisPosition();
      }
      
      if (null != gGlobal.ControlInput.JoyStick2) {
        wJ2_State = gGlobal.ControlInput.JoyStick2.getAxisPosition();
      }
      
      var wDOM = document.getElementById("Temp")
      wDOM.innerText = JSON.stringify(wJ1_State, null ,2) + JSON.stringify(wJ2_State, null ,2);

      gGlobal.Ownship.eulerAngle[0] = wJ2_State.z;
      gGlobal.Ownship.eulerAngle[1] = wJ2_State.y;
      gGlobal.Ownship.eulerAngle[2] += wJ2_State.x*0.1;
/*
      
  			gGlobal.ViewPoint.Camera.rotation.y -= wJ2_State.x*0.1;
	  		gGlobal.ViewPoint.Camera.rotation.x = wJ2_State.y*0.1;
		  	gGlobal.ViewPoint.Camera.rotation.z = wJ2_State.z*0.1;
        gGlobal.ViewPoint.Camera.position.x += wJ1_State.x*5;
  			gGlobal.ViewPoint.Camera.position.y += wJ1_State.y*5;
      	gGlobal.ViewPoint.Camera.position.z += wJ1_State.z*5;
  */      
/*
      wCube = gGlobal.ViewPoint.Scene.getObjectByName( "Planet", true );
			wCube.rotation.y += wJ2_State.x*0.1;
			wCube.rotation.x += wJ2_State.y*0.1;
      wCube.rotation.z += wJ2_State.z*0.1;
      */

    }

    function updateEntities(iDt) {

      var wLocation = gGlobal.Ownship.location;
      var wPosition = convertGeoLocationToCartesian(wLocation[0],wLocation[1],wLocation[2]);
      
      var wEuler = gGlobal.Ownship.eulerAngle;
      var wEulerQuat = getEulerQuaternion(wLocation[0],wLocation[1], wEuler[0],wEuler[1],wEuler[2]);

      gGlobal.ViewPoint.Camera.position.set(wPosition.x,wPosition.y,wPosition.z);
      gGlobal.ViewPoint.Camera.rotation.setFromQuaternion(wEulerQuat);

      var wEntityList = [
        {
          id:"Ownship",
          time : (new Date()).getTime(),
          location : gGlobal.Ownship.location,
          eulerAngle : gGlobal.Ownship.eulerAngle,
          modelPath : "https://wlee0515.github.io/site/pages/SimpleGame/Horse.glb"
        }
      ]
      
      gGlobal.webRTI.setObject("EntityManager", "EntityList", wEntityList);

      var wRemote = gGlobal.webRTI.getRemoteObjectList("EntityManager", "EntityList");

      if (null != wRemote) {

        var wEntries = Object.entries(wRemote);
        
        for (var wi = 0 ; wi < wEntries.length; ++wi){
          var wRemoteList = wEntries[wi][1];
        
          for (var wj = 0 ; wj < wRemoteList.length; ++wj){
            var wEntity = wRemoteList[wj];
            var wEntityId = gGlobal.EntityManger.generateEntityIdString(wEntries[wi][0],wEntity.id );
            gGlobal.EntityManger.setEntityPosition(wEntityId, wEntity.location, wEntity.eulerAngle);
            gGlobal.EntityManger.setEntityModel(wEntityId, wEntity.modelPath)
          }     

        }
      }
      gGlobal.EntityManger.removeNoneUpdated();

    }

    function processTime(iDt) {
      updateJoystick(iDt);
      updateEntities(iDt);
      updateScene(iDt);
    }

    function tick() {

      var wTimeStep = (new Date()).getTime() - gGlobal.Time.LastTimeStamp;
      wTimeStep /= 1000;
      processTime(wTimeStep);
      window.requestAnimationFrame(tick);
      gGlobal.Time.LastTimeStamp = (new Date()).getTime();

    }


  </script>
  <script type="module">
    
    import GamePadObj from "https://wlee0515.github.io/site/modules/GamePad.mjs";

    function init() {
      
      if (null != GamePadObj){
        var wJ1 = document.getElementById(gGlobal.ControlInput.OutputDiv_J1_id);
        gGlobal.ControlInput.JoyStick1 = new GamePadObj.ThreeAxisJoystick(wJ1, true, 2);

        var wJ2 = document.getElementById(gGlobal.ControlInput.OutputDiv_J2_id);
        gGlobal.ControlInput.JoyStick2 = new GamePadObj.ThreeAxisJoystick(wJ2, false, 7);
      }
      


      gGlobal.socket = io("http://webrti.herokuapp.com");
//        gGlobal.socket = io("http://localhost");
      gGlobal.webRTI = new WebRTI(gGlobal.socket);
      gGlobal.EntityManger = new EntityManager();

      setupViewPoint();
  		setupScene();
      tick();
    }

    window.addEventListener("load", init);
  </script>

</head>

<style>
  body {
    background: rgb(255, 255, 255);
    margin: 0;
    padding: 0;
  }

  #id_JoyStick_1 {
    width: 150px;
    height: 150px;
    z-index: 100;
    position: fixed;
    bottom: 10px;
    left: 10px;
  }
  
  #id_JoyStick_2 {
    width: 150px;
    height: 150px;
    z-index: 100;
    position: fixed;
    bottom: 10px;
    right: 10px;
  }
  
  #id_OutputCanvasContainer {
    width: 100vw;
    height: 100vh;
    z-index: 100;
    position: fixed;
    top: 0px;
    left: 0px;
  }
</style>
<body>
  <div id="id_OutputCanvasContainer">
    <canvas id="id_OutputCanvas"></canvas>
  </div>
  <div id="Temp"></div>
  <div id="id_JoyStick_1">
  </div>
  <div id="id_JoyStick_2">
  </div>
  </br>
</body>

</html>