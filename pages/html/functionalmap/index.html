<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Functional Map Generator</title>
  <link rel="stylesheet" type="text/css" href="../../css/theme_01.css">
  <script src="./databasemap.js"></script>
  <style>
    #map-canvas-div {
      width: 100vw;
      height: calc( 100vh - 45px);
      max-height: 100%;
      max-width: 100%;
    }
    
    #map-canvas {
      width: 100%;
      height: 100%;
      margin: auto;
      background-color: white;
    }

    #map-textarea {
      width: calc(100% - 30px);
      height: 100px;
      overflow: scroll;
      margin: auto;
    }

    #heading-div {
      position: fixed;
      top: 0px;
      left:0px;
      padding: 0px;
      width: 100vw;
      margin: 0px;
      z-index:1;
      background-color: inherit;
      min-height:25px;
    }

    #heading-checkbox {
      display:none;
    }

    #heading-toggle {
      font-size: 10px;
      color: blue;
    }
    
    #heading-title {
      font-weight: bold;
      font-size: 30px;
    }
    #heading-checkbox:checked+span{
      font-size: 10px;
    }

    #app-div {
      position: fixed;
      bottom: 0px;
      left:0px;
      width: 100vw;
      padding: 0px;
      margin: 0px;
    }

    .nav-option-display {
      min-height: 10vh;
      width: 100%;
    }

    .navbar {
      overflow-x: hidden;
    }

    .nav-option-tab {
      height: 20px;
      width: calc( 100% / 6 - 10px);
      float: left;
    }

  </style>
  <script type="text/javascript">
    var wInitialFile = "./functionalmap.json"
    var gFunctionalMapObject = new DatabaseMap("Database");
    var gCanvasWidth = 1000;

    function download(filename, text) {
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
    }

    function runObject() {
      var wTextArea = document.getElementById("map-textarea");
      if (null != wTextArea) {
        var wObj = JSON.parse(wTextArea.value);
        if (null != wObj) {
          gFunctionalMapObject = wObj;
        }
      }
      updateIO();
    }

    function saveObject() {
      if (null != gFunctionalMapObject) {
        download("FunctionalMap.json", JSON.stringify(gFunctionalMapObject, null, 2));
      }
      else {
        alert("Functional Map Objet is null")
      }
    }

    function loadJSON() {

      if (!window.FileReader) return; // Browser is not compatible

      var wFile = document.getElementById("FileInput");
      var txt = "";
      if ('files' in wFile) {
        if (wFile.files.length == 0) {
          txt = "Select one or more files.";
        } else {


          var reader = new FileReader();

          reader.onload = function (evt) {
            if (evt.target.readyState != 2) return;
            if (evt.target.error) {
              alert('Error while reading file');
              return;
            }

            var wObj = JSON.parse(evt.target.result);
            if (null != wObj) {
              gFunctionalMapObject = wObj;
            }

            updateIO();

          };

          reader.readAsText(wFile.files[0]);
        }
      }
      ;
    }

    function syncSelectOptionWithArray(iElementID, iStringArray){
      
      var wSelect = document.getElementById(iElementID);
      if (null != wSelect){
        if (0 != wSelect.options.length){
          while (wSelect.options.length > iStringArray.length){
            wSelect.remove(wSelect.options.length - 1);
          }
        }

        while (wSelect.options.length < iStringArray.length){
          var wOpt = document.createElement('option');
          wOpt.value = iStringArray[wSelect.options.length];
          wOpt.innerHTML = iStringArray[wSelect.options.length];
          wSelect.appendChild(wOpt);
        }

        for(var i = 0; i < wSelect.options.length; ++i){
          if (wSelect.options[i] != iStringArray[0]){
            wSelect.options[i].value = iStringArray[i];
            wSelect.options[i].innerHTML = iStringArray[i];
          }
        }
      }
    }

    function updateIO() {

      var wTextArea = document.getElementById("map-textarea");

      if (null != wTextArea) {
        wTextArea.value = JSON.stringify(gFunctionalMapObject, null, 2);
      }

      var wDBName = document.getElementById("io-dbname");

      if (null != wDBName) {
        wDBName.value = Database_getDatabaseName(gFunctionalMapObject);
      }


      var wDatabaseSourceList = Database_getSourceList(gFunctionalMapObject);
      syncSelectOptionWithArray("io-selectsource",wDatabaseSourceList);

      var wDatabaseUserList = Database_getUserList(gFunctionalMapObject);
      syncSelectOptionWithArray("io-selectuser", wDatabaseUserList);
      syncSelectOptionWithArray("io-action-selectuser", wDatabaseUserList);

      updateactionselect();

    }

    function updateactionselect() {
      var wSelectedUser = document.getElementById("io-action-selectuser");
      var wUserActionList = [];
      if ("" != wSelectedUser.value) {
        wUserActionList = Database_getUserActionList(gFunctionalMapObject, wSelectedUser.value);
      }
      syncSelectOptionWithArray("io-selectaction", wUserActionList);
    }


    function drawImageCenteredAt(iCtx, iImage, iCenterX, iCenterY, iWidth, iHeight) {

      var wDBCornerX = iCenterX - iWidth / 2;
      var wDBCornerY = iCenterY - iHeight / 2;

      iCtx.drawImage(iImage, wDBCornerX, wDBCornerY, iWidth, iHeight);
    }

    function drawRectCenteredAt(iCtx, iCenterX, iCenterY, iWidth, iHeight) {

      iCtx.fillRect(iCenterX - iWidth / 2, iCenterY - iHeight / 2, iWidth, iHeight);
      iCtx.strokeRect(iCenterX - iWidth / 2, iCenterY - iHeight / 2, iWidth, iHeight);

    }

    function drawTextCenteredAt(iCtx, iCenterX, iCenterY, iText) {

      iCtx.textAlign = "center";
      iCtx.textBaseline = "middle";
      iCtx.fillText(iText, iCenterX, iCenterY);

    }

    function drawLabelTextAt(iCtx, iCenterX, iCenterY, iText, iBackColor, iTextColor) {

      if ("" != iBackColor) {
        iCtx.fillStyle = iBackColor;
        iCtx.strokeStyle = iTextColor;
        drawRectCenteredAt(iCtx, iCenterX, iCenterY - 0.1 * parseInt(iCtx.font), iCtx.measureText(iText).width + 10, parseInt(iCtx.font) + 5);
      }

      iCtx.fillStyle = iTextColor;
      iCtx.strokeStyle = iTextColor;
      drawTextCenteredAt(iCtx, iCenterX, iCenterY, iText);

    }

    function renderCanvas() {

      var wCanvasHeight = gCanvasWidth;
      var wCanvasWidth = gCanvasWidth;

      var wIconSize = 60;
      var wUserRadius = gCanvasWidth / 2 - 2.25 * wIconSize;
      var wFont = "10pt Arial";
      var wLabelColor = "white";
      var wTextColor = "black"
      var wCenterYOffset = - wIconSize;
      var wSourceYOffset = wUserRadius - 1.5*wIconSize;

      if (null == gFunctionalMapObject) {
        return;
      }

      var wCanvas = document.getElementById("map-canvas");

      if (null == wCanvas) {
        return;
      }

      var wImage_db = document.getElementById("img-database");

      if (null == wImage_db) {
        return;
      }

      var wImage_user = document.getElementById("img-user");

      if (null == wImage_user) {
        return;
      }


      var wCtx = wCanvas.getContext("2d");

      if (null == wCtx) {
        return;
      }

      var wCanvasCenterX = 0;
      var wCanvasCenterY = 0 - wCenterYOffset;

      var wDatabaseName = Database_getDatabaseName(gFunctionalMapObject);
      var wDatabaseSourceList = Database_getSourceList(gFunctionalMapObject);
      var wDatabaseUserList = Database_getUserList(gFunctionalMapObject);

      wCtx.clearRect(0, 0, wCanvas.width, wCanvas.height);

      // Scale to screen
      var dpr = window.devicePixelRatio || 1;
      var wNewSize = wCanvas.height;
      if (wNewSize > wCanvas.width) wNewSize = wCanvas.width;
      wNewSize /= dpr;

      var wImageCenterX = wCanvas.width / 2;
      wImageCenterX /= dpr;

      var wImageCenterY = wCanvas.height / 2;
      wImageCenterY /= dpr;

      wCtx.translate(wImageCenterX, wImageCenterY);

      var wImageScale = wNewSize / wCanvasWidth;
      wCtx.scale(wImageScale, wImageScale);

      wCtx.font = wFont;

      if (0 != wDatabaseSourceList.length) {
        var wSubDBIconSize = wIconSize * 0.6;
        var wIconBox = 2.0 * wSubDBIconSize;

        var wMaxTextSize = 0;
        for (var i = 0; i < wDatabaseSourceList.length; ++i) {
          var wMeasure = wCtx.measureText(wDatabaseSourceList[i]).width;
          if (wMaxTextSize < wMeasure) {
            wMaxTextSize = wMeasure;
          }
        }
        wMaxTextSize += wSubDBIconSize;

        var wCountPerLine = Math.floor(wCanvasWidth / (wMaxTextSize));

        if (wDatabaseSourceList.length < wCountPerLine) {
          wCountPerLine = wDatabaseSourceList.length;
        }

        var wSpacing = wCanvasWidth / (wCountPerLine + 1);
        var wXOffset = wCanvasWidth / 2;

        for (var i = 0; i < wDatabaseSourceList.length; ++i) {
          var wCenterX = (i % wCountPerLine + 1) * wSpacing - wXOffset;
          var wCenterY = -(Math.floor(i / wCountPerLine)) * wIconBox - wSourceYOffset;

          drawImageCenteredAt(wCtx, wImage_db, wCenterX, wCenterY, wSubDBIconSize, wSubDBIconSize);
          drawLabelTextAt(wCtx, wCenterX, wCenterY + wSubDBIconSize / 2 + parseInt(wCtx.font), wDatabaseSourceList[i], wLabelColor, wTextColor);

        }

      }

      if (0 != wDatabaseUserList.length) {

        var wUserIconAngle = ((2 / 4) * Math.PI + Math.PI) / wDatabaseUserList.length;
        var wAngleOff = wUserIconAngle / 2 - (1 / 4) * Math.PI;

        for (var i = 0; i < wDatabaseUserList.length; ++i) {
          var wAngle = wAngleOff + i * wUserIconAngle;

          var wUserRadiusWithSign = wUserRadius;
          var wRotateAngle = wAngle;
          var wRadius = 0.5 * (wUserRadius - wIconSize / 2) + wIconSize / 2;
          if (Math.PI / 2 < Math.abs(wRotateAngle)) {
            wRotateAngle += Math.PI;
            wRadius *= -1;
            wUserRadiusWithSign *= -1;
          }

          wCtx.translate(wCanvasCenterX, wCanvasCenterY);
          wCtx.rotate(wRotateAngle);

          var wUserActionList = Database_getUserActionList(gFunctionalMapObject, wDatabaseUserList[i]);

          if (0 != wUserActionList.length) {
            var wSpacing = parseInt(wCtx.font) * 2.0;
            var wTotalHeight = wUserActionList.length * wSpacing;
            var wStart = -(wTotalHeight - wSpacing) / 2;

            for (var j = 0; j < wUserActionList.length; ++j) {
              var wHeight = wStart + j * wSpacing;

              wCtx.beginPath();
              wCtx.moveTo(0, 0);
              wCtx.quadraticCurveTo(0, wHeight, wRadius, wHeight);
              wCtx.moveTo(wUserRadiusWithSign, 0);
              wCtx.quadraticCurveTo(wUserRadiusWithSign, wHeight, wRadius, wHeight);

              wCtx.strokeStyle = wTextColor;
              wCtx.stroke();

              drawLabelTextAt(wCtx, wRadius, wHeight, wUserActionList[j], wLabelColor, wTextColor);
            }

          }

          wCtx.rotate(-wRotateAngle);

          wCtx.translate(-wCanvasCenterX, -wCanvasCenterY);

          var wCenterX = Math.cos(wAngle) * wUserRadius + wCanvasCenterX;
          var wCenterY = Math.sin(wAngle) * wUserRadius + wCanvasCenterY;

          var wTextHeight = parseInt(wCtx.font);

          wCtx.beginPath();
          wCtx.arc(wCenterX, wCenterY, wIconSize, 0, 2 * Math.PI);
          wCtx.closePath();
          wCtx.fillStyle = wLabelColor;
          wCtx.strokeStyle = wTextColor;
          wCtx.fill();
          wCtx.stroke();

          drawImageCenteredAt(wCtx, wImage_user, wCenterX, wCenterY - wTextHeight, wIconSize, wIconSize);
          drawLabelTextAt(wCtx, wCenterX, wCenterY + wIconSize / 2, wDatabaseUserList[i], wLabelColor, wTextColor);

        }
      }

      wCtx.beginPath();
      wCtx.arc(wCanvasCenterX, wCanvasCenterY, 1.5 * wIconSize, 0, 2 * Math.PI);
      wCtx.closePath();
      wCtx.fillStyle = wLabelColor;
      wCtx.strokeStyle = wTextColor;
      wCtx.fill();
      wCtx.stroke();

      drawImageCenteredAt(wCtx, wImage_db, wCanvasCenterX, wCanvasCenterY - parseInt(wCtx.font), wIconSize, wIconSize);
      drawLabelTextAt(wCtx, wCanvasCenterX, wCanvasCenterY + wIconSize / 2, wDatabaseName, wLabelColor, wTextColor);

      wCtx.scale(1 / wImageScale, 1 / wImageScale);
      wCtx.translate(-wImageCenterX, -wImageCenterY);
    }

    function init() {

      // Replace ./data.json with your JSON feed
      fetch(wInitialFile).then(response => {
        return response.json();
      }).then(data => {

        gFunctionalMapObject = data;
        loadObjToTextArea();

      }).catch(err => {
        Database_editDatabaseName(gFunctionalMapObject, "User APP Event Data");

        Database_addSource(gFunctionalMapObject, "Phone Sales");
        Database_addSource(gFunctionalMapObject, "Game Data");
        Database_addSource(gFunctionalMapObject, "Population Data");
        Database_addSource(gFunctionalMapObject, "Location Date");
        Database_addSource(gFunctionalMapObject, "Transit Data");

        Database_addUser(gFunctionalMapObject, "Developers");
        Database_addUserAction(gFunctionalMapObject, "Developers", "App Trends");
        Database_addUserAction(gFunctionalMapObject, "Developers", "App Usage");
        Database_addUserAction(gFunctionalMapObject, "Developers", "App Ideas");

        Database_addUser(gFunctionalMapObject, "Manufacturer");
        Database_addUserAction(gFunctionalMapObject, "Manufacturer", "Phone Sales");
        Database_addUserAction(gFunctionalMapObject, "Manufacturer", "Phone Use condition");
        Database_addUserAction(gFunctionalMapObject, "Manufacturer", "Customer Location");
        Database_addUserAction(gFunctionalMapObject, "Manufacturer", "Customer Demographic");

        Database_addUser(gFunctionalMapObject, "Advertisers");
        Database_addUserAction(gFunctionalMapObject, "Advertisers", "Ad Placement");
        Database_addUserAction(gFunctionalMapObject, "Advertisers", "Ad KPI");

        Database_addUser(gFunctionalMapObject, "Infrastructure");
        Database_addUserAction(gFunctionalMapObject, "Infrastructure", "Network Traffic");
        Database_addUserAction(gFunctionalMapObject, "Infrastructure", "Transit Activity");

        Database_addUser(gFunctionalMapObject, "Phone User");
        Database_addUserAction(gFunctionalMapObject, "Phone User", "Get User Activity");

        Database_addUser(gFunctionalMapObject, "Authority");
        Database_addUserAction(gFunctionalMapObject, "Authority", "User Location Data");
        Database_addUserAction(gFunctionalMapObject, "Authority", "User Phone Activity");
        Database_addUserAction(gFunctionalMapObject, "Authority", "Spam Detection");

        updateIO();
      });

      resize();
      updateIO();

      setInterval(renderCanvas,200);
    }

    function resize() {

      var wCanvas = document.getElementById("map-canvas");

      if (null != wCanvas) {

        var dpr = window.devicePixelRatio || 1;
        var wRect = wCanvas.getBoundingClientRect();
        wCanvas.height = wRect.height * dpr;
        wCanvas.width = wRect.width * dpr
        var wCtx = wCanvas.getContext('2d');
        wCtx.scale(dpr, dpr);

      }
    }
    
    
    function updateDatabaseName() {
      var wName = document.getElementById("io-dbname");
      if (null != wName) {
        Database_editDatabaseName(gFunctionalMapObject, wName.value);
        updateIO();
      }
    }
    
    function clearDatabase() {
      Database_clearDatabase(gFunctionalMapObject);
      updateIO();
    }
    
    function addDatabaseSource() {
      var wName = document.getElementById("io-addsource");
      if (null != wName) {
        Database_addSource(gFunctionalMapObject, wName.value);
        updateIO();
      }
    }

    function removeDatabaseSource() {
      var wSourceSelect = document.getElementById("io-selectsource");
      if (null != wSourceSelect) {
        Database_removeSource(gFunctionalMapObject, wSourceSelect.value);
        updateIO();
      }
    }

    function editDatabaseSource() {
      var wSourceSelect = document.getElementById("io-selectsource");
      var wSourceEdit = document.getElementById("io-editsource");
      if ((null != wSourceSelect) && (null != wSourceEdit)) {
        Database_editSource(gFunctionalMapObject, wSourceSelect.value, wSourceEdit.value);
        updateIO();
      }
    }
    
    function addDatabaseUser() {
      var wName = document.getElementById("io-adduser");
      if (null != wName) {
        Database_addUser(gFunctionalMapObject, wName.value);
        updateIO();
      }
    }
    
    function removeDatabaseUser() {
      var wUserSelect = document.getElementById("io-selectuser");
      if (null != wUserSelect) {
        Database_removeUser(gFunctionalMapObject, wUserSelect.value);
        updateIO();
      }
    }
    
    function editDatabaseUser() {
      var wUserSelect = document.getElementById("io-selectuser");
      var wUserEdit = document.getElementById("io-edituser");
      if ((null != wUserSelect) && (null != wUserEdit)) {
        Database_editUserLabel(gFunctionalMapObject, wUserSelect.value, wUserEdit.value);
        updateIO();
      }
    }
    
    function addDatabaseAction() {
      
      var wSelectedUser = document.getElementById("io-action-selectuser");
      if (null != wSelectedUser) {
        var wName = document.getElementById("io-addaction");
        if (null != wName) {
          Database_addUserAction(gFunctionalMapObject, wSelectedUser.value, wName.value);
          updateIO();
        }
      }
    }
    
    function removeDatabaseAction() {
      
      var wSelectedUser = document.getElementById("io-action-selectuser");
      if (null != wSelectedUser) {
        var wActionSelect = document.getElementById("io-selectaction");
        if (null != wActionSelect) {
          Database_removeUserAction(gFunctionalMapObject, wSelectedUser.value, wActionSelect.value);
          updateIO();
        }
      }
    }
    
    function editDatabaseAction() {
      var wSelectedUser = document.getElementById("io-action-selectuser");
      if (null != wSelectedUser) {
        var wActionSelect = document.getElementById("io-selectaction");
        var wActionEdit = document.getElementById("io-editaction");
        if ((null != wActionSelect) && (null != wActionEdit)) {
          Database_editUserAction(gFunctionalMapObject,wSelectedUser.value, wActionSelect.value, wActionEdit.value);
          updateIO();
        }
      }
    }

  </script>
</head>
<body onload="init()" onresize="resize()">
  <div id="main-content-div">
    <div id="heading-div">
      <input id="heading-checkbox" type="checkbox" name="navmenu">
      <span id="heading-title"><label for="heading-checkbox">Software Dev's Functional Map Generator</label></span>
      <label id="heading-toggle" for="heading-checkbox">Toggle size</label>
    </div>
    <div id="app-div">
      <div id="map-canvas-div">
        <canvas id="map-canvas"></canvas>
      </div>
      <div class="navbar">
        <div class="navbar-menu">
          <label class="nav-option-tab option-01" for="nav-tab-01">Database</label>
          <label class="nav-option-tab option-02" for="nav-tab-02">Sources</label>
          <label class="nav-option-tab option-03" for="nav-tab-03">Users</label>
          <label class="nav-option-tab option-04" for="nav-tab-04">Actions</label>
          <label class="nav-option-tab option-05" for="nav-tab-05">File</label>
          <label class="nav-option-tab option-06" for="nav-tab-06">Hide</label>
        </div>

        <div class="nav-display">
          <input class="nav-option-radio-bt" id="nav-tab-01" type="radio" name="navmenu">
          <div class="nav-option-display option-01">
            <span>Change Database Name</span>
            </br>
            <input type="text" id="io-dbname" class="io-form-text"/>
            <input type="button" class="io-form-bt" value="Change" onclick="updateDatabaseName()"/>
            </br>
            <input type="button" class="io-form-bt" value="Clear Database" onclick="clearDatabase()" />
          </div>
          <input class="nav-option-radio-bt" id="nav-tab-02" type="radio" name="navmenu">
          <div class="nav-option-display option-02">
            <span>Edit Database Sources</span>
            </br>
            <input type="text" id="io-addsource" class="io-form-text"/>
            <input type="button" class="io-form-bt"value="Add" onclick="addDatabaseSource()" />
            </br>
            <select id="io-selectsource" class="io-form-select"></select>
            <input type="button" class="io-form-bt"value="Remove" onclick="removeDatabaseSource()" />
            </br>
            <input type="text" id="io-editsource" class="io-form-text"/>
            <input type="button" class="io-form-bt"value="Change" onclick="editDatabaseSource()" />
          </div>
          <input class="nav-option-radio-bt" id="nav-tab-03" type="radio" name="navmenu">
          <div class="nav-option-display option-03">
            <span>Edit Database Users</span>
            </br>
            <input type="text" id="io-adduser" class="io-form-text"/>
            <input type="button" class="io-form-bt" value="Add" onclick="addDatabaseUser()" />
            </br>
            <select id="io-selectuser" class="io-form-select"></select>
            <input type="button" class="io-form-bt" value="Remove" onclick="removeDatabaseUser()" />
            </br>
            <input type="text" id="io-edituser" class="io-form-text"/>
            <input type="button" class="io-form-bt" value="Change" onclick="editDatabaseUser()" />
          </div>
          <input class="nav-option-radio-bt" id="nav-tab-04" type="radio" name="navmenu">
          <div class="nav-option-display option-04">
            <span>Edit Database User Actions</span> 
            </br>
            <select id="io-action-selectuser" class="io-form-select" onchange="updateactionselect()"></select>
            </br>
            <input type="text" id="io-addaction" class="io-form-text" />
            <input type="button" class="io-form-bt" value="Add" onclick="addDatabaseAction()" />
            </br>
            <select id="io-selectaction" class="io-form-select"></select>
            <input type="button" class="io-form-bt" value="Remove" onclick="removeDatabaseAction()" />
            </br>
            <input type="text" id="io-editaction" class="io-form-text" />
            <input type="button" class="io-form-bt" value="Change" onclick="editDatabaseAction()" />
          </div>
          <input class="nav-option-radio-bt" id="nav-tab-05" type="radio" name="navmenu">
          <div class="nav-option-display option-05">
            <textarea id="map-textarea"></textarea>
            </br>
            <input type="button" value="Run" onclick="runObject()" />
            <input type="button" value="Save" onclick="saveObject()" />
            <input type="file" id="FileInput" size="50" onchange="loadJSON()">
          </div>
          <input class="nav-option-radio-bt" id="nav-tab-06" type="radio" name="navmenu">
        </div>
      </div>
    </div>
  </div>
  <div id="imageLibrary" style="display:none;">
    <img id="img-database" src="./images/database-icon.png">
    <img id="img-user" src="./images/user-icon.png">
  </div>
</body>
</html>
