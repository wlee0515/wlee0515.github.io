<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>Functional Map Generator</title>
    <link rel="stylesheet" type="text/css" href="../../css/theme_01.css">
    <script src="./databasemap.js" ></script>
    <style>
        #map-canvas-div
        {
            width: 100%;
            height: 500px;
            background-color: white;
        }

        #map-textarea-div
        {
            width: 100%;
        }

        #map-textarea
        {
            width: calc(100% - 20px);
            height: 300px;
            overflow: scroll;
        }
    </style>
    <script type="text/javascript">
        var wInitialFile = "./functionalmap.json"
        var gFunctionalMapObject = new DatabaseMap("Database");

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        function runObject() {
            var wTextArea = document.getElementById("map-textarea");
            if (null != wTextArea) {
                var wObj = JSON.parse(wTextArea.value);
                if (null != wObj) {
                    gFunctionalMapObject = wObj;
                }
            }
            loadObjToTextArea();
        }

        function saveObject() {
            if (null != gFunctionalMapObject) {
                download("FunctionalMap.json", JSON.stringify(gFunctionalMapObject, null, 2));
            }
            else {
                alert("Functional Map Objet is null")
            }
        }

        function loadJSON() {

            if (!window.FileReader) return; // Browser is not compatible

            var wFile = document.getElementById("FileInput");
            var txt = "";
            if ('files' in wFile) {
                if (wFile.files.length == 0) {
                    txt = "Select one or more files.";
                } else {


                    var reader = new FileReader();

                    reader.onload = function (evt) {
                        if (evt.target.readyState != 2) return;
                        if (evt.target.error) {
                            alert('Error while reading file');
                            return;
                        }

                        var wObj = JSON.parse(evt.target.result);
                        if (null != wObj) {
                            gFunctionalMapObject = wObj;
                        }

                        loadObjToTextArea();

                    };

                    reader.readAsText(wFile.files[0]);
                }
            }
            ;
        }

        function loadObjToTextArea() {

            var wTextArea = document.getElementById("map-textarea");

            if (null != wTextArea) {
                wTextArea.value = JSON.stringify(gFunctionalMapObject, null, 2);
            }
        }

        function drawImageCenteredAt(iCtx, iImage, iCenterX, iCenterY, iWidth, iHeight) {

            var wDBCornerX = iCenterX - iWidth / 2;
            var wDBCornerY = iCenterY - iHeight / 2;

            iCtx.drawImage(iImage, wDBCornerX, wDBCornerY, iWidth, iHeight);
        }

        function drawRectCenteredAt(iCtx, iCenterX, iCenterY, iWidth, iHeight) {

            iCtx.fillRect(iCenterX - iWidth / 2, iCenterY - iHeight / 2, iWidth, iHeight);

        }

        function drawTextCenteredAt(iCtx, iCenterX, iCenterY, iText) {

            iCtx.textAlign = "center";
            iCtx.textBaseline = "middle";
            iCtx.fillText(iText, iCenterX, iCenterY);

        }
        
        function drawLabelTextAt(iCtx, iCenterX, iCenterY, iText, iBackColor, iTextColor) {

            iCtx.fillStyle = iBackColor;
            drawRectCenteredAt(iCtx, iCenterX, iCenterY, iCtx.measureText(iText).width + 20, parseInt(iCtx.font) + 10);
            iCtx.fillStyle = iTextColor;
            drawTextCenteredAt(iCtx, iCenterX, iCenterY, iText);

        }

        function renderCanvas() {
            var wIconSize = 75;
            var wUserRadius = 150;

            if (null == gFunctionalMapObject) {
                return;
            }

            var wCanvas = document.getElementById("map-canvas");

            if (null == wCanvas) {
                return;
            }
            
            var wImage_db = document.getElementById("img-database");

            if (null == wImage_db) {
                return;
            }
            
            var wImage_user = document.getElementById("img-user");

            if (null == wImage_user) {
                return;
            }
            

            var wCtx = wCanvas.getContext("2d");

            if (null == wCtx) {
                return;
            }

            var wCanvasHeight = wCanvas.height;
            var wCanvasWidth = wCanvas.width;

            var wCanvasCenterX = wCanvasWidth / 2;
            var wCanvasCenterY = wCanvasHeight / 2;

            var wDatabaseName = Database_getDatabaseName(gFunctionalMapObject);
            var wDatabaseSourceList = Database_getSourceList(gFunctionalMapObject);
            var wDatabaseUserList = Database_getUserList(gFunctionalMapObject);

            wCtx.clearRect(0, 0, wCanvasWidth, wCanvasHeight);

            wCtx.font = "10pt Arial";

            if (0 != wDatabaseSourceList.length) {
                var wSubDBIconSize = wIconSize * 0.75;
                var wBaseY = wSubDBIconSize;
                for (var i = 0; i < wDatabaseSourceList.length; ++i) {
                    var w = wAngleOff + i * wUserIconAngle;
                    var wCenterX = wBaseY;
                    var wCenterY = wBaseY + Math.floor(i/2) * (wBaseY + 30);

                    if (1 == i % 2) {
                        wCenterX = wCanvasWidth - wBaseY;
                    }

                    drawImageCenteredAt(wCtx, wImage_db, wCenterX, wCenterY, wSubDBIconSize, wSubDBIconSize);
                    drawLabelTextAt(wCtx, wCenterX, wCenterY + wSubDBIconSize / 2 + parseInt(wCtx.font), wDatabaseSourceList[i], "white", "black");

                }

            }

            if (0 != wDatabaseUserList.length) {

                var wUserIconAngle = 2*Math.PI/wDatabaseUserList.length;
                var wAngleOff = wUserIconAngle/2;

                for (var i = 0; i < wDatabaseUserList.length; ++i) {
                    var wAngle = wAngleOff + i* wUserIconAngle;
                    var wCenterX = Math.cos(wAngle)*wUserRadius + wCanvasCenterX;
                    var wCenterY = Math.sin(wAngle)*wUserRadius + wCanvasCenterY;

                    drawImageCenteredAt(wCtx, wImage_user, wCenterX, wCenterY, wIconSize, wIconSize);
                    drawLabelTextAt(wCtx, wCenterX, wCenterY + wIconSize / 2 + parseInt(wCtx.font), wDatabaseUserList[i], "white", "black");

                }
            
            }

            drawImageCenteredAt(wCtx, wImage_db, wCanvasCenterX, wCanvasCenterY, wIconSize, wIconSize);
            drawLabelTextAt(wCtx, wCanvasCenterX, wCanvasCenterY + wIconSize / 2 + parseInt(wCtx.font), wDatabaseName, "white", "black");
        }

        function init() {
            resize();
            Database_changeLabel(gFunctionalMapObject, "China-Mobile User Data");

            Database_addSource(gFunctionalMapObject, "Call List");
            Database_editSource(gFunctionalMapObject, "Call List", "Call Center");
            Database_addSource(gFunctionalMapObject, "Call List");
            Database_removeSource(gFunctionalMapObject, "Call List");

            Database_addUser(gFunctionalMapObject, "China-Mobile User Event Data");
            Database_addUser(gFunctionalMapObject, "User01");
            Database_editUserLabel(gFunctionalMapObject, "China-Mobile User Event Data", "User02");
            Database_removeUser(gFunctionalMapObject, "User03");
            Database_addUser(gFunctionalMapObject, "User03");

            Database_addUserAction(gFunctionalMapObject, "User01", "buy");
            Database_addUserAction(gFunctionalMapObject, "User01", "sell");
            Database_editUserAction(gFunctionalMapObject, "User01", "buy", "buy-All");
            Database_removeUserAction(gFunctionalMapObject, "User01", "buy");
            Database_addUserAction(gFunctionalMapObject, "User01", "buy-again");
 
            loadObjToTextArea();

            setInterval( renderCanvas, 30);
        }


        function resize() {
            var wCanvas = document.getElementById("map-canvas");

            if (null != wCanvas) {
                wCanvas.height = wCanvas.parentElement.clientHeight - 2;
                wCanvas.width = wCanvas.parentElement.clientWidth - 2;
            }
        }

    </script>
</head>
<body onload="init()" onresize="resize()">
    <div id="main-content-div">
        <h1>Software Dev's Functional Map Generator</h1>
        <div id="map-canvas-div">
            <canvas id="map-canvas" style="border: 1px solid #999"></canvas>
        </div>
        <div class="navbar">
            <div class="navbar-menu">
                <label class="nav-option-tab option-01" for="nav-tab-01">Database</label>
                <label class="nav-option-tab option-02" for="nav-tab-02">User</label>
                <label class="nav-option-tab option-03" for="nav-tab-03">Action</label>
            </div>

            <div class="nav-display">
                <input class="nav-option-radio-bt" id="nav-tab-01" type="radio" name="navmenu" checked="checked">
                <div class="nav-option-display option-01">
                    Thiis some text for Rad 1
                </div>
                <input class="nav-option-radio-bt" id="nav-tab-02" type="radio" name="navmenu">
                <div class="nav-option-display option-02">
                    Thiis some text for Rad 2
                </div>
                <input class="nav-option-radio-bt" id="nav-tab-03" type="radio" name="navmenu">
                <div class="nav-option-display option-03">
                    Thiis some text for Rad 3
                </div>
            </div>
        </div>
        <div id="map-textarea-div">
            <textarea id="map-textarea"></textarea>
            </br>
      <input type="button" value="Run" onclick="runObject()" />
            <input type="button" value="Save" onclick="saveObject()" />
            <input type="file" id="FileInput" size="50" onchange="loadJSON()">
        </div>
    </div>
    <div id="imageLibrary" style="display:none;">
        <img id="img-database" src="./images/database-icon.png">
        <img id="img-user" src="./images/user-icon.png">
    </div>
</body>
</html>
