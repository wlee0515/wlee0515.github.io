<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Functional Map Generator</title>
  <link rel="stylesheet" type="text/css" href="../../css/theme_01.css">
  <script src="./databasemap.js"></script>
  <style>
    #map-canvas-div {
      width: 100%;
      height: 600px;
      background-color: white;
    }

    #map-textarea {
      width: calc(100% - 15px);
      height: calc(100% - 50px);
      overflow: scroll;
      margin: auto;
    }

    #map-canvas {
      width: 100%;
      height: 100%;
    }

    .nav-option-display {
      height: 400px;
    }
  </style>
  <script type="text/javascript">
    var wInitialFile = "./functionalmap.json"
    var gFunctionalMapObject = new DatabaseMap("Database");

    function download(filename, text) {
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
    }

    function runObject() {
      var wTextArea = document.getElementById("map-textarea");
      if (null != wTextArea) {
        var wObj = JSON.parse(wTextArea.value);
        if (null != wObj) {
          gFunctionalMapObject = wObj;
        }
      }
      loadObjToTextArea();
    }

    function saveObject() {
      if (null != gFunctionalMapObject) {
        download("FunctionalMap.json", JSON.stringify(gFunctionalMapObject, null, 2));
      }
      else {
        alert("Functional Map Objet is null")
      }
    }

    function loadJSON() {

      if (!window.FileReader) return; // Browser is not compatible

      var wFile = document.getElementById("FileInput");
      var txt = "";
      if ('files' in wFile) {
        if (wFile.files.length == 0) {
          txt = "Select one or more files.";
        } else {


          var reader = new FileReader();

          reader.onload = function (evt) {
            if (evt.target.readyState != 2) return;
            if (evt.target.error) {
              alert('Error while reading file');
              return;
            }

            var wObj = JSON.parse(evt.target.result);
            if (null != wObj) {
              gFunctionalMapObject = wObj;
            }

            loadObjToTextArea();

          };

          reader.readAsText(wFile.files[0]);
        }
      }
      ;
    }

    function loadObjToTextArea() {

      var wTextArea = document.getElementById("map-textarea");

      if (null != wTextArea) {
        wTextArea.value = JSON.stringify(gFunctionalMapObject, null, 2);
      }
    }

    function drawImageCenteredAt(iCtx, iImage, iCenterX, iCenterY, iWidth, iHeight) {

      var wDBCornerX = iCenterX - iWidth / 2;
      var wDBCornerY = iCenterY - iHeight / 2;

      iCtx.drawImage(iImage, wDBCornerX, wDBCornerY, iWidth, iHeight);
    }

    function drawRectCenteredAt(iCtx, iCenterX, iCenterY, iWidth, iHeight) {

      iCtx.fillRect(iCenterX - iWidth / 2, iCenterY - iHeight / 2, iWidth, iHeight);

    }

    function drawTextCenteredAt(iCtx, iCenterX, iCenterY, iText) {

      iCtx.textAlign = "center";
      iCtx.textBaseline = "middle";
      iCtx.fillText(iText, iCenterX, iCenterY);

    }

    function drawLabelTextAt(iCtx, iCenterX, iCenterY, iText, iBackColor, iTextColor) {

      if ("" != iBackColor)
      {
        iCtx.fillStyle = iBackColor;
        drawRectCenteredAt(iCtx, iCenterX, iCenterY, iCtx.measureText(iText).width + 20, parseInt(iCtx.font) + 10);
      }

      iCtx.fillStyle = iTextColor;
      drawTextCenteredAt(iCtx, iCenterX, iCenterY, iText);

    }

    function renderCanvas() {
      var wIconSize = 60;
      var wUserRadius = 250;
      var wFont = "9pt Arial";
      var wLabelColor = "";
      var wTextColor = "black"

      if (null == gFunctionalMapObject) {
        return;
      }

      var wCanvas = document.getElementById("map-canvas");

      if (null == wCanvas) {
        return;
      }

      var wImage_db = document.getElementById("img-database");

      if (null == wImage_db) {
        return;
      }

      var wImage_user = document.getElementById("img-user");

      if (null == wImage_user) {
        return;
      }


      var wCtx = wCanvas.getContext("2d");

      if (null == wCtx) {
        return;
      }

      var dpr = window.devicePixelRatio || 1;
      var wCanvasHeight = wCanvas.height / dpr;
      var wCanvasWidth = wCanvas.width / dpr;

      var wCanvasCenterX = wCanvasWidth / 2;
      var wCanvasCenterY = wCanvasHeight / 2 - wIconSize;

      var wDatabaseName = Database_getDatabaseName(gFunctionalMapObject);
      var wDatabaseSourceList = Database_getSourceList(gFunctionalMapObject);
      var wDatabaseUserList = Database_getUserList(gFunctionalMapObject);

      wCtx.clearRect(0, 0, wCanvasWidth, wCanvasHeight);

      wCtx.font = wFont;

      if (0 != wDatabaseSourceList.length) {
        var wSubDBIconSize = wIconSize * 0.6;
        var wIconBox = 2.0 * wSubDBIconSize;
        var wCountPerLine = Math.floor(wCanvasWidth / (wIconBox));

        if (wDatabaseSourceList.length < wCountPerLine) {
          wCountPerLine = wDatabaseSourceList.length;
        }
        
        var wSpacing = wCanvasWidth /( wCountPerLine + 1);

        for (var i = 0; i < wDatabaseSourceList.length; ++i) {
          var wCenterX = (i % wCountPerLine + 1) * wSpacing;
          var wCenterY = (Math.floor(i / wCountPerLine) + 0.5) * wIconBox;


          drawImageCenteredAt(wCtx, wImage_db, wCenterX, wCenterY, wSubDBIconSize, wSubDBIconSize);
          drawLabelTextAt(wCtx, wCenterX, wCenterY + wSubDBIconSize / 2 + parseInt(wCtx.font), wDatabaseSourceList[i], wLabelColor, wTextColor);

        }

      }

      if (0 != wDatabaseUserList.length) {

        var wUserIconAngle = ((2 / 4) * Math.PI + Math.PI) / wDatabaseUserList.length;
        var wAngleOff = wUserIconAngle / 2 - (1 / 4) * Math.PI;

        wCtx.translate(wCanvasCenterX, wCanvasCenterY)
        for (var i = 0; i < wDatabaseUserList.length; ++i) {
          var wAngle = wAngleOff + i * wUserIconAngle;

          var wRotateAngle = wAngle;
          var wRadius = 0.5 * (wUserRadius - wIconSize / 2) + wIconSize / 2;
          if (Math.PI / 2 < Math.abs(wRotateAngle)) {
            wRotateAngle += Math.PI;
            wRadius *= -1;
          }

          wCtx.rotate(wRotateAngle);

          
          var wUserActionList = Database_getUserActionList(gFunctionalMapObject, wDatabaseUserList[i]);

          if (0 != wUserActionList.length)
          {
            var wSpacing = parseInt(wCtx.font) * 1.2;
            var wTotalHeight = wUserActionList.length * wSpacing;
            var wStart = -wTotalHeight / 2 + wSpacing;
            
            for (var j = 0; j < wUserActionList.length; ++j) {
              var wHeight = wStart + j * wSpacing;
              drawLabelTextAt(wCtx, wRadius, wHeight, wUserActionList[j], wLabelColor, wTextColor);
            }

          }

          wCtx.rotate(-wRotateAngle);


          var wCenterX = Math.cos(wAngle) * wUserRadius;
          var wCenterY = Math.sin(wAngle) * wUserRadius;

          drawImageCenteredAt(wCtx, wImage_user, wCenterX, wCenterY, wIconSize, wIconSize);
          drawLabelTextAt(wCtx, wCenterX, wCenterY + wIconSize / 2 + parseInt(wCtx.font), wDatabaseUserList[i], wLabelColor, wTextColor);

        }

        wCtx.translate(-wCanvasCenterX, -wCanvasCenterY)
      }

      drawImageCenteredAt(wCtx, wImage_db, wCanvasCenterX, wCanvasCenterY, wIconSize, wIconSize);
      drawLabelTextAt(wCtx, wCanvasCenterX, wCanvasCenterY + wIconSize / 2 + parseInt(wCtx.font), wDatabaseName, wLabelColor, wTextColor);
    }

    function init() {
      resize();
      Database_changeLabel(gFunctionalMapObject, "User APP Event");

      Database_addSource(gFunctionalMapObject, "Phone Sales");
      Database_addSource(gFunctionalMapObject, "Game Ranking");
      Database_addSource(gFunctionalMapObject, "Population Age");
      Database_addSource(gFunctionalMapObject, "Work Location");
      Database_addSource(gFunctionalMapObject, "Home Address");

      Database_addUser(gFunctionalMapObject, "Developers");
      Database_addUserAction(gFunctionalMapObject, "Developers", "App Trends");
      Database_addUserAction(gFunctionalMapObject, "Developers", "App Ranking");

      Database_addUser(gFunctionalMapObject, "Manufacturer");
      Database_addUserAction(gFunctionalMapObject, "Manufacturer", "Phone Sales");
      Database_addUserAction(gFunctionalMapObject, "Manufacturer", "Product Targeting");
      Database_addUserAction(gFunctionalMapObject, "Manufacturer", "Locate Customer");

      Database_addUser(gFunctionalMapObject, "Advertisers");
      Database_addUserAction(gFunctionalMapObject, "Advertisers", "Ad Placement");
      Database_addUserAction(gFunctionalMapObject, "Advertisers", "Ad Effectiveness");

      Database_addUser(gFunctionalMapObject, "Infastructucture");
      Database_addUserAction(gFunctionalMapObject, "Infastructucture", "High Traffic area");

      Database_addUser(gFunctionalMapObject, "Phone User");
      Database_addUserAction(gFunctionalMapObject, "Phone User", "Get User Activity");
      Database_addUserAction(gFunctionalMapObject, "Phone User", "Find User Activeity");

      Database_addUser(gFunctionalMapObject, "Investigater");
      Database_addUserAction(gFunctionalMapObject, "Investigater", "Track User Location");
      Database_addUserAction(gFunctionalMapObject, "Investigater", "User APP usage");
      Database_addUserAction(gFunctionalMapObject, "Investigater", "Find User pattern");

      loadObjToTextArea();

      setInterval(renderCanvas, 30);
    }


    function resize() {
      var wCanvasDiv = document.getElementById("map-canvas-div");
      
      if (null != wCanvasDiv) {

        var wSize = wCanvasDiv.clientHeight;
        if (wSize < wCanvasDiv.clientWidth) wSize = wCanvasDiv.clientWidth;

        wCanvasDiv.height = wSize;
        wCanvasDiv.width = wSize;

      }

      var wCanvas = document.getElementById("map-canvas");

      if (null != wCanvas) {

        var dpr = window.devicePixelRatio || 1;
        var wRect = wCanvas.getBoundingClientRect();
        wCanvas.height = wRect.height * dpr;
        wCanvas.width = wRect.width * dpr
        var wCtx = wCanvas.getContext('2d');
        wCtx.scale(dpr, dpr);

      }
    }

  </script>
</head>
<body onload="init()" onresize="resize()">
  <div id="main-content-div">
    <h1>Software Dev's Functional Map Generator</h1>
    <div id="map-canvas-div">
      <canvas id="map-canvas" style="border: 1px solid #999"></canvas>
    </div>
    <div class="navbar">
      <div class="navbar-menu">
        <label class="nav-option-tab option-01" for="nav-tab-01">Database</label>
        <label class="nav-option-tab option-02" for="nav-tab-02">Source</label>
        <label class="nav-option-tab option-03" for="nav-tab-03">User</label>
        <label class="nav-option-tab option-04" for="nav-tab-04">Action</label>
        <label class="nav-option-tab option-05" for="nav-tab-05">File</label>
      </div>

      <div class="nav-display">
        <input class="nav-option-radio-bt" id="nav-tab-01" type="radio" name="navmenu" checked="checked">
        <div class="nav-option-display option-01">
          <>
        </div>
        <input class="nav-option-radio-bt" id="nav-tab-02" type="radio" name="navmenu">
        <div class="nav-option-display option-02">
          Thiis some text for Rad 2
        </div>
        <input class="nav-option-radio-bt" id="nav-tab-03" type="radio" name="navmenu">
        <div class="nav-option-display option-03">
          Thiis some text for Rad 3
        </div>
        <input class="nav-option-radio-bt" id="nav-tab-04" type="radio" name="navmenu">
        <div class="nav-option-display option-04">
          Thiis some text for Rad 3
        </div>
        <input class="nav-option-radio-bt" id="nav-tab-05" type="radio" name="navmenu">
        <div class="nav-option-display option-05">
          <textarea id="map-textarea"></textarea>
          </br>
          <input type="button" value="Run" onclick="runObject()" />
          <input type="button" value="Save" onclick="saveObject()" />
          <input type="file" id="FileInput" size="50" onchange="loadJSON()">
        </div>
      </div>
    </div>
  </div>
  <div id="imageLibrary" style="display:none;">
    <img id="img-database" src="./images/database-icon.png">
    <img id="img-user" src="./images/user-icon.png">
  </div>
</body>
</html>
