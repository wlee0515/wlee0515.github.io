<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>Functional Map Generator</title>
    <link rel="stylesheet" type="text/css" href="../../css/theme_01.css">
    <style>
        #map-canvas-div
        {
            width: calc(100% - 20px);
            height: 500px;
        }

        #map-textarea-div
        {
            width: 100%;
        }

        #map-textarea
        {
            width: calc(100% - 20px);
            height: 300px;
            overflow: scroll;
        }
    </style>
    <script type="text/javascript">
        var wInitialFile = "./functionalmap.json"
        var gFunctionalMapObject = null;

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        function runObject() {
            var wTextArea = document.getElementById("map-textarea");
            if (null != wTextArea) {
                var wObj = JSON.parse(wTextArea.value);
                if (null != wObj) {
                    gFunctionalMapObject = wObj;
                }
            }
            loadObjToTextArea();
        }

        function saveObject() {
            if (null != gFunctionalMapObject) {
                download("FunctionalMap.json", JSON.stringify(gFunctionalMapObject, null, 2));
            }
            else {
                alert("Functional Map Objet is null")
            }
        }

        function loadJSON() {

            if (!window.FileReader) return; // Browser is not compatible

            var wFile = document.getElementById("FileInput");
            var txt = "";
            if ('files' in wFile) {
                if (wFile.files.length == 0) {
                    txt = "Select one or more files.";
                } else {


                    var reader = new FileReader();

                    reader.onload = function (evt) {
                        if (evt.target.readyState != 2) return;
                        if (evt.target.error) {
                            alert('Error while reading file');
                            return;
                        }

                        var wObj = JSON.parse(evt.target.result);
                        if (null != wObj) {
                            gFunctionalMapObject = wObj;
                        }

                        loadObjToTextArea();

                    };

                    reader.readAsText(wFile.files[0]);
                }
            }
            ;
        }

        function loadObjToTextArea() {

            var wTextArea = document.getElementById("map-textarea");

            if (null != wTextArea) {
                wTextArea.value = JSON.stringify(gFunctionalMapObject, null, 2);
            }
        }

        function drawImageCenteredAt(iCtx, iImage, iCenterX, iCenterY, iWidth, iHeight) {

            var wDBCornerX = iCenterX - iWidth / 2;
            var wDBCornerY = iCenterY - iHeight / 2;

            iCtx.drawImage(iImage, wDBCornerX, wDBCornerY, iWidth, iHeight);
        }

        function drawRectCenteredAt(iCtx, iCenterX, iCenterY, iWidth, iHeight) {

            iCtx.fillRect(iCenterX - iWidth / 2, iCenterY - iHeight / 2, iWidth, iHeight);

        }

        function drawTextCenteredAt(iCtx, iCenterX, iCenterY, iText) {

            iCtx.textAlign = "center";
            iCtx.textBaseline = "middle";
            iCtx.fillText(iText, iCenterX, iCenterY);

        }
        
        function drawLabelTextAt(iCtx, iCenterX, iCenterY, iText, iBackColor, iTextColor) {

            iCtx.fillStyle = iBackColor;
            drawRectCenteredAt(iCtx, iCenterX, iCenterY, iCtx.measureText(iText).width + 20, parseInt(iCtx.font) + 10);
            iCtx.fillStyle = iTextColor;
            drawTextCenteredAt(iCtx, iCenterX, iCenterY, iText);

        }

        function renderCanvas() {
            var wIconSize = 100;

            if (null == gFunctionalMapObject) {
                return;
            }

            var wCanvas = document.getElementById("map-canvas");

            if (null == wCanvas) {
                return;
            }
            
            var wImage_db = document.getElementById("img-database");

            if (null == wImage_db) {
                return;
            }
            
            var wImage_user = document.getElementById("img-user");

            if (null == wImage_user) {
                return;
            }
            

            var wCtx = wCanvas.getContext("2d");

            if (null == wCtx) {
                return;
            }

            var wCanvasHeight = wCanvas.height;
            var wCanvasWidth = wCanvas.width;

            var wCanvasCenterX = wCanvasWidth / 2;
            var wCanvasCenterY = wCanvasHeight / 2;

            drawImageCenteredAt(wCtx, wImage_db, wCanvasCenterX, wCanvasCenterY, wIconSize, wIconSize);

            wCtx.font = "20pt Arial";
            var wDatabaseName = "Database getting bigger ";
            drawLabelTextAt(wCtx, wCanvasCenterX, wCanvasCenterY, wDatabaseName, "white", "black");

            drawImageCenteredAt(wCtx, wImage_user,0, 0, wIconSize, wIconSize);


        }

        function init() {
            resize();

            gFunctionalMapObject = {
                Database: {
                    label: "China-Mobile User Event Data",
                    sources: [
                      "Source 1",
                      "Source 2"
                    ],
                    users: [
                      {
                          label: "User01",
                          actions: [
                            "act1",
                            "act2"
                          ]
                      },
                      {
                          label: "User02",
                          actions: [
                            "act1",
                            "act2"
                          ]
                      }

                    ]
                }
            }
            loadObjToTextArea();
            renderCanvas();
        }


        function resize() {
            var wCanvas = document.getElementById("map-canvas");

            if (null != wCanvas) {
                wCanvas.height = wCanvas.parentElement.clientHeight - 2;
                wCanvas.width = wCanvas.parentElement.clientWidth - 2;
            }
        }

    </script>
</head>
<body onload="init()" onresize="resize()">
    <div id="main-content-div">
        <h1>Software Dev's Functional Map Generator</h1>
        <div id="map-canvas-div">
            <canvas id="map-canvas" style="border: 1px solid #999"></canvas>
        </div>
        <div class="navbar">
            <div class="navbar-menu">
                <label class="nav-option-tab option-01" for="nav-tab-01">Database</label>
                <label class="nav-option-tab option-02" for="nav-tab-02">User</label>
                <label class="nav-option-tab option-03" for="nav-tab-03">Action</label>
            </div>

            <div class="nav-display">
                <input class="nav-option-radio-bt" id="nav-tab-01" type="radio" name="navmenu" checked="checked">
                <div class="nav-option-display option-01">
                    Thiis some text for Rad 1
                </div>
                <input class="nav-option-radio-bt" id="nav-tab-02" type="radio" name="navmenu">
                <div class="nav-option-display option-02">
                    Thiis some text for Rad 2
                </div>
                <input class="nav-option-radio-bt" id="nav-tab-03" type="radio" name="navmenu">
                <div class="nav-option-display option-03">
                    Thiis some text for Rad 3
                </div>
            </div>
        </div>
        <div id="map-textarea-div">
            <textarea id="map-textarea"></textarea>
            </br>
      <input type="button" value="Run" onclick="runObject()" />
            <input type="button" value="Save" onclick="saveObject()" />
            <input type="file" id="FileInput" size="50" onchange="loadJSON()">
        </div>
    </div>
    <div id="imageLibrary" style="display:block;">
        <img id="img-database" src="./images/database-icon.png">
        <img id="img-user" src="./images/user-icon.png">
    </div>
</body>
</html>
